<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Wellness">
    <link rel="manifest" href="./manifest.json">
    <title>Wellness & Medication Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            border: none;
            background: none;
            font-size: 0.95em;
            min-width: 100px;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            background: white;
        }

        .content {
            padding: 25px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Calendar Styles */
        .calendar-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header h2 {
            color: #667eea;
            font-size: 1.5em;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: #5a6fd6;
            transform: translateY(-1px);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            color: #667eea;
            padding: 10px 5px;
            font-size: 0.9em;
        }

        .calendar-day {
            min-height: 130px;
            background: white;
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .calendar-day.today {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f3ff 0%, #e8ecff 100%);
        }

        .calendar-day.other-month {
            opacity: 0.4;
        }

        .calendar-day .day-number {
            font-weight: 600;
            color: #495057;
            font-size: 1em;
        }

        .calendar-day.today .day-number {
            color: #667eea;
        }

        .calendar-day .day-indicators {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin-top: 5px;
            align-content: flex-start;
        }

        .day-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .day-dot.completed {
            background: #28a745;
        }

        .day-dot.partial {
            background: #ffc107;
        }

        .day-dot.missed {
            background: #9b7bb8;
        }

        .day-dot.pending {
            background: #6c757d;
        }

        .calendar-day .day-status {
            font-size: 0.7em;
            color: #6c757d;
        }

        .calendar-day .day-notes {
            font-size: 0.7em;
            color: #667eea;
            margin-top: 6px;
            line-height: 1.3;
            word-break: break-word;
        }

        /* Today's Quick Actions */
        .today-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            margin-bottom: 25px;
        }

        .today-section h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .today-meds {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .med-item {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .med-item:hover {
            background: rgba(255,255,255,0.25);
        }

        .med-item.taken {
            background: rgba(40, 167, 69, 0.4);
        }

        .med-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #28a745;
        }

        .med-item .med-info {
            flex: 1;
        }

        .med-item .med-name {
            font-weight: 600;
            font-size: 1em;
        }

        .med-item .med-time {
            font-size: 0.85em;
            opacity: 0.8;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 1.3em;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .modal-body {
            padding: 25px;
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .modal-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        input[type="number"],
        input[type="text"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Slider Styles */
        .slider-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .slider-label span:first-child {
            font-weight: 600;
            color: #495057;
        }

        .slider-label .slider-value {
            color: #667eea;
            font-weight: 700;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        /* Button Styles */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 0.95em;
            width: auto;
        }

        /* Medication Checklist in Modal */
        .med-checklist {
            display: grid;
            gap: 10px;
        }

        .med-check-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .med-check-item:hover {
            background: #e9ecef;
        }

        .med-check-item.checked {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .med-check-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
        }

        .med-check-item .med-details {
            flex: 1;
        }

        .med-check-item .med-name {
            font-weight: 600;
            color: #495057;
        }

        .med-check-item .med-schedule {
            font-size: 0.85em;
            color: #6c757d;
        }

        /* Sleep Tracking Section */
        .sleep-section {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 20px;
            border-radius: 15px;
            color: white;
        }

        .sleep-section h3 {
            color: #a8d8ea;
            margin-bottom: 15px;
        }

        .sleep-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .sleep-input {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .sleep-input label {
            display: block;
            color: #a8d8ea;
            font-size: 0.85em;
            margin-bottom: 8px;
        }

        .sleep-input input,
        .sleep-input select {
            background: rgba(255,255,255,0.9);
            color: #1a1a2e;
        }

        /* Tapering Tracker Styles */
        .taper-timeline {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0;
        }

        .taper-phase {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            position: relative;
        }

        .taper-phase.active {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .taper-phase.completed {
            border-left-color: #6c757d;
            opacity: 0.7;
        }

        .taper-phase.future {
            border-left-color: #ffc107;
        }

        .taper-phase h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .taper-phase.active h4 {
            color: #28a745;
        }

        .taper-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .taper-stat {
            text-align: center;
        }

        .taper-stat .value {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .taper-stat .label {
            font-size: 0.85em;
            color: #6c757d;
        }

        /* Recovery Timeline Styles */
        .timeline-section {
            margin-bottom: 30px;
        }

        .timeline-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }

        .timeline-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .timeline-card.libido {
            border-left-color: #e91e63;
        }

        .timeline-card.sleep {
            border-left-color: #3f51b5;
        }

        .timeline-card.nad {
            border-left-color: #ff9800;
        }

        .timeline-card.hormones {
            border-left-color: #9c27b0;
        }

        .timeline-list {
            list-style: none;
        }

        .timeline-list li {
            padding: 10px 0;
            padding-left: 25px;
            position: relative;
            border-bottom: 1px solid #e9ecef;
        }

        .timeline-list li:last-child {
            border-bottom: none;
        }

        .timeline-list li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }

        .week-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 8px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card .stat-value {
            font-size: 2em;
            font-weight: 700;
            margin: 8px 0;
        }

        .stat-card .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
        }

        /* History Entry Cards */
        .entry-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .entry-date {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
        }

        .entry-meds {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .entry-med-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .entry-med-badge.taken {
            background: #d4edda;
            color: #155724;
        }

        .entry-med-badge.missed {
            background: #f8d7da;
            color: #721c24;
        }

        .entry-sleep {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .entry-notes {
            background: white;
            padding: 12px;
            border-radius: 8px;
            font-style: italic;
            color: #6c757d;
        }

        /* Reminders Section */
        .reminder-card {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .reminder-info h4 {
            color: #495057;
            margin-bottom: 5px;
        }

        .reminder-info p {
            font-size: 0.9em;
            color: #6c757d;
        }

        .reminder-time {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        /* Labs Section */
        .lab-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .lab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .lab-date {
            font-weight: 600;
            color: #667eea;
        }

        .lab-values {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .lab-value-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
        }

        .lab-value-item .name {
            font-size: 0.85em;
            color: #6c757d;
        }

        .lab-value-item .value {
            font-weight: 700;
            color: #495057;
        }

        /* Chart Container */
        .chart-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            height: 350px;
        }

        canvas {
            max-width: 100%;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }

            .calendar-day {
                min-height: 100px;
                padding: 8px;
            }

            .calendar-day .day-number {
                font-size: 0.9em;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                flex: 1 1 33%;
                padding: 12px 8px;
                font-size: 0.85em;
            }
        }

        /* Notification Permission Banner */
        .notification-banner {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .notification-banner.granted {
            background: #d4edda;
            border-color: #28a745;
        }

        .notification-banner p {
            flex: 1;
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Wellness & Medication Tracker</h1>
            <p>Track your medications, sleep, and recovery journey</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('calendar')">Calendar</button>
            <button class="tab" onclick="switchTab('history')">History</button>
            <button class="tab" onclick="switchTab('sleep')">Sleep Trends</button>
            <button class="tab" onclick="switchTab('tapering')">Tapering</button>
            <button class="tab" onclick="switchTab('labs')">Labs</button>
            <button class="tab" onclick="switchTab('reminders')">Reminders</button>
            <button class="tab" onclick="switchTab('timeline')">Recovery Guide</button>
        </div>

        <div class="content">
            <!-- Calendar Tab -->
            <div id="calendar" class="tab-content active">
                <!-- Notification Banner -->
                <div id="notification-banner" class="notification-banner" style="display: none;">
                    <p><strong>Enable notifications</strong> to get reminders for your medications</p>
                    <button onclick="requestNotificationPermission()" class="btn btn-small">Enable</button>
                </div>

                <!-- TRT & NAD+ Status Dashboard -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <!-- TRT Status Card -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white;">
                        <h3 style="color: white; margin: 0 0 20px 0;">üíâ TRT Status</h3>
                        <!-- Main Stats Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center; margin-bottom: 15px;">
                            <div style="background: rgba(255,255,255,0.15); padding: 12px 8px; border-radius: 10px;">
                                <div style="opacity: 0.8; font-size: 11px; margin-bottom: 5px;">NEXT DUE</div>
                                <div id="trt-next-due" style="font-size: 1.1em; font-weight: 700;">-</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 12px 8px; border-radius: 10px;">
                                <div style="opacity: 0.8; font-size: 11px; margin-bottom: 5px;">DAYS ON TRT</div>
                                <div id="trt-days-badge" style="font-size: 1.3em; font-weight: 700;">0</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 12px 8px; border-radius: 10px;">
                                <div style="opacity: 0.8; font-size: 11px; margin-bottom: 5px;">LAST SHOT</div>
                                <div id="trt-last-shot" style="font-size: 1em; font-weight: 600;">Not recorded</div>
                                <div id="trt-last-site" style="font-size: 0.8em; opacity: 0.8; margin-top: 3px;"></div>
                            </div>
                        </div>
                        <!-- Start Date -->
                        <div style="display: flex; align-items: center; gap: 10px; font-size: 12px; opacity: 0.8;">
                            <span>Started:</span>
                            <input type="date" id="trt-start-date-input" style="padding: 4px 8px; border-radius: 5px; border: none; font-size: 11px; background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.8);" onchange="saveTrtStartDate()">
                        </div>
                        <!-- Testosterone Mini Chart -->
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                            <div style="opacity: 0.8; font-size: 12px; margin-bottom: 10px;">üìà LIBIDO TRACKING</div>
                            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 10px;">
                                <canvas id="trt-mini-chart" height="100"></canvas>
                                <div id="trt-chart-empty" style="text-align: center; padding: 20px; opacity: 0.7; display: none;">Log daily check-ins to see libido trends</div>
                            </div>
                        </div>
                    </div>

                    <!-- NAD+ Status Card -->
                    <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px; border-radius: 15px; color: white;">
                        <h3 style="color: white; margin: 0 0 20px 0;">üíâ NAD+ Status</h3>
                        <!-- Main Stats Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center; margin-bottom: 15px;">
                            <div style="background: rgba(255,255,255,0.15); padding: 12px 8px; border-radius: 10px;">
                                <div style="opacity: 0.8; font-size: 11px; margin-bottom: 5px;">NEXT DUE</div>
                                <div id="nad-next-due" style="font-size: 1.1em; font-weight: 700;">-</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 12px 8px; border-radius: 10px;">
                                <div style="opacity: 0.8; font-size: 11px; margin-bottom: 5px;">DAYS ON NAD+</div>
                                <div id="nad-days-badge" style="font-size: 1.3em; font-weight: 700;">0</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.15); padding: 12px 8px; border-radius: 10px;">
                                <div style="opacity: 0.8; font-size: 11px; margin-bottom: 5px;">LAST SHOT</div>
                                <div id="nad-last-shot" style="font-size: 1em; font-weight: 600;">Not recorded</div>
                                <div id="nad-last-site" style="font-size: 0.8em; opacity: 0.8; margin-top: 3px;"></div>
                            </div>
                        </div>
                        <!-- Start Date -->
                        <div style="display: flex; align-items: center; gap: 10px; font-size: 12px; opacity: 0.8;">
                            <span>Started:</span>
                            <input type="date" id="nad-start-date-input" style="padding: 4px 8px; border-radius: 5px; border: none; font-size: 11px; background: rgba(255,255,255,0.15); color: rgba(255,255,255,0.8);" onchange="saveNadStartDate()">
                        </div>
                        <!-- Site Rotation -->
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                            <div style="opacity: 0.8; font-size: 12px; margin-bottom: 10px;">üìç SITE ROTATION</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; text-align: center;">
                                    <div style="opacity: 0.7; font-size: 10px; margin-bottom: 5px;">LAST USED</div>
                                    <div id="nad-last-used-date" style="font-size: 0.9em; font-weight: 600;">-</div>
                                    <div id="nad-last-used-site" style="font-size: 1.1em; font-weight: 700; margin-top: 5px;">-</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px; text-align: center;">
                                    <div style="opacity: 0.7; font-size: 10px; margin-bottom: 5px;">USE TODAY</div>
                                    <div id="nad-use-today-date" style="font-size: 0.9em; font-weight: 600;">-</div>
                                    <div id="nad-use-today-site" style="font-size: 1.1em; font-weight: 700; margin-top: 5px; color: #ffeb3b;">-</div>
                                </div>
                            </div>
                        </div>
                        <!-- NAD+ Energy Chart -->
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                            <div style="opacity: 0.8; font-size: 12px; margin-bottom: 10px;">‚ö° ENERGY LEVELS (Since First Shot)</div>
                            <div style="background: rgba(255,255,255,0.1); border-radius: 10px; padding: 10px;">
                                <canvas id="nad-mini-chart" height="100"></canvas>
                                <div id="nad-chart-empty" style="text-align: center; padding: 20px; opacity: 0.7; display: none;">Log daily check-ins to see energy trends</div>
                            </div>
                            <div style="margin-top: 8px; font-size: 11px; opacity: 0.9;">
                                <span style="color: #fff;">‚óè</span> Energy &nbsp;
                                <span style="color: #FF1493;">‚óè</span> NAD+ Shot Day
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today's Quick Actions -->
                <div class="today-section">
                    <h3>Today - <span id="today-date"></span></h3>
                    <div class="today-meds" id="today-meds">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Calendar -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h2 id="calendar-month-year"></h2>
                        <div class="calendar-nav">
                            <button onclick="changeMonth(-1)">‚Üê Prev</button>
                            <button onclick="goToToday()">Today</button>
                            <button onclick="changeMonth(1)">Next ‚Üí</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Current Streak</div>
                        <div class="stat-value" id="stat-streak">0</div>
                        <div class="stat-label">days</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">This Week</div>
                        <div class="stat-value" id="stat-week-compliance">0%</div>
                        <div class="stat-label">compliance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Sleep</div>
                        <div class="stat-value" id="stat-avg-sleep">-</div>
                        <div class="stat-label">hours</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Energy</div>
                        <div class="stat-value" id="stat-avg-energy">-</div>
                        <div class="stat-label">/10</div>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="history" class="tab-content">
                <h2 style="color: #667eea; margin-bottom: 20px;">Symptom Trends</h2>

                <!-- Wellbutrin Restart Date Marker -->
                <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; color: white; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <span style="font-weight: 600;">Wellbutrin Restart Date:</span>
                    <input type="date" id="wellbutrin-restart-date" style="padding: 8px 12px; border-radius: 8px; border: none; font-size: 14px;" onchange="saveWellbutrinRestartDate()">
                    <span style="opacity: 0.9; font-size: 13px;">(Shows as vertical line on chart)</span>
                </div>

                <!-- Symptom Chart -->
                <div style="margin-bottom: 20px;">
                    <label style="font-weight: 600; margin-right: 10px;">Select metrics to display:</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="chart-motivation" checked onchange="saveChartCheckboxes(); renderSymptomChart()">
                            <span style="color: #667eea;">Motivation</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="chart-energy" checked onchange="saveChartCheckboxes(); renderSymptomChart()">
                            <span style="color: #28a745;">Energy</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="chart-mood" checked onchange="saveChartCheckboxes(); renderSymptomChart()">
                            <span style="color: #ffc107;">Mood</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="chart-libido" onchange="saveChartCheckboxes(); renderSymptomChart()">
                            <span style="color: #e83e8c;">Libido</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="chart-clarity" onchange="saveChartCheckboxes(); renderSymptomChart()">
                            <span style="color: #17a2b8;">Mental Clarity</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="chart-anxiety" onchange="saveChartCheckboxes(); renderSymptomChart()">
                            <span style="color: #dc3545;">Anxiety</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="chart-wellbeing" onchange="saveChartCheckboxes(); renderSymptomChart()">
                            <span style="color: #6f42c1;">Well-being</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="chart-temperature" checked onchange="saveChartCheckboxes(); renderSymptomChart()">
                            <span style="color: #fd7e14;">Temperature</span>
                        </label>
                    </div>
                </div>
                <div class="chart-container" style="margin-bottom: 30px;">
                    <canvas id="symptomChart"></canvas>
                </div>

                <!-- Stats Summary -->
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-label">Avg Motivation</div>
                        <div class="stat-value" id="symptom-avg-motivation">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Energy</div>
                        <div class="stat-value" id="symptom-avg-energy">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Mood</div>
                        <div class="stat-value" id="symptom-avg-mood">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Temperature</div>
                        <div class="stat-value" id="symptom-avg-temperature">-</div>
                    </div>
                </div>

                <h3 style="color: #667eea; margin-bottom: 15px;">Entry History</h3>
                <div id="history-container">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Sleep Trends Tab -->
            <div id="sleep" class="tab-content">
                <h2 style="color: #667eea; margin-bottom: 20px;">Sleep Trends</h2>
                <div class="chart-container">
                    <canvas id="sleepChart"></canvas>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Avg Hours</div>
                        <div class="stat-value" id="sleep-avg-hours">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Quality</div>
                        <div class="stat-value" id="sleep-avg-quality">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Best Night</div>
                        <div class="stat-value" id="sleep-best">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Avg Wake-ups</div>
                        <div class="stat-value" id="sleep-avg-wakeups">-</div>
                    </div>
                </div>
            </div>

            <!-- Tapering Tab -->
            <div id="tapering" class="tab-content">
                <h2 style="color: #667eea; margin-bottom: 20px;">Wellbutrin Tapering Tracker</h2>

                <div id="taper-not-started" style="display: none;">
                    <div style="background: #f8f9fa; padding: 30px; border-radius: 15px; text-align: center;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Ready to Start Tapering?</h3>
                        <p style="color: #6c757d; margin-bottom: 20px;">When you're ready to begin your Wellbutrin taper, set your start date below.</p>
                        <div class="form-group" style="max-width: 300px; margin: 0 auto 20px;">
                            <label>Taper Start Date</label>
                            <input type="date" id="taper-start-date">
                        </div>
                        <button onclick="startTaper()" class="btn" style="max-width: 300px;">Start Tapering Plan</button>
                    </div>
                </div>

                <div id="taper-active" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Current Dose</div>
                            <div class="stat-value" id="taper-current-dose">300mg</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Days at Dose</div>
                            <div class="stat-value" id="taper-days-at-dose">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Next Reduction</div>
                            <div class="stat-value" id="taper-next-date">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Progress</div>
                            <div class="stat-value" id="taper-progress">0%</div>
                        </div>
                    </div>

                    <div class="taper-timeline" id="taper-timeline">
                        <!-- Populated by JS -->
                    </div>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-top: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Log Withdrawal Symptoms</h3>
                        <div class="form-row">
                            <div>
                                <label>Date</label>
                                <input type="date" id="withdrawal-date" value="">
                            </div>
                            <div>
                                <label>Severity (1-10)</label>
                                <input type="number" id="withdrawal-severity" min="1" max="10" placeholder="1-10">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label>Symptoms</label>
                            <textarea id="withdrawal-notes" placeholder="Describe any symptoms: dizziness, brain zaps, mood changes, etc."></textarea>
                        </div>
                        <button onclick="logWithdrawalSymptom()" class="btn">Log Symptom</button>
                    </div>

                    <div style="margin-top: 20px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">Symptom Log</h3>
                        <div id="withdrawal-log">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div style="margin-top: 30px; text-align: center;">
                        <button onclick="resetTaper()" class="btn btn-danger btn-small">Reset Tapering Plan</button>
                    </div>
                </div>
            </div>

            <!-- Labs Tab -->
            <div id="labs" class="tab-content">
                <h2 style="color: #667eea; margin-bottom: 20px;">Lab Results</h2>

                <div style="margin-bottom: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Lab Trends</h3>
                    <div class="form-group" style="max-width: 300px;">
                        <select id="lab-chart-select" onchange="updateLabChart()">
                            <option value="testosterone">Testosterone Total</option>
                            <option value="testosteroneFree">Free Testosterone</option>
                            <option value="estradiol">Estradiol</option>
                            <option value="progesterone">Progesterone</option>
                            <option value="shbg">SHBG</option>
                            <option value="prolactin">Prolactin</option>
                            <option value="dhea">DHEA-S</option>
                            <option value="tsh">TSH</option>
                            <option value="t4">Free T4</option>
                            <option value="t3">Free T3</option>
                            <option value="vitd">Vitamin D</option>
                            <option value="b12">Vitamin B12</option>
                            <option value="ferritin">Ferritin</option>
                            <option value="glucose">Glucose</option>
                            <option value="hba1c">HbA1c</option>
                            <option value="cholesterol">Total Cholesterol</option>
                            <option value="ldl">LDL</option>
                            <option value="hdl">HDL</option>
                            <option value="triglycerides">Triglycerides</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="labChart"></canvas>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">Lab History</h3>
                    <div id="labs-container">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Add Lab Results</h3>
                    <div class="form-group">
                        <label>Lab Date</label>
                        <input type="date" id="lab-date">
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <!-- Hormones -->
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #e9ecef;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">Hormones</h4>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>Testosterone Total (ng/dL)</label>
                                <input type="number" step="0.01" id="lab-testosterone" placeholder="e.g., 45.2">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>Free Testosterone / cFT (pg/mL)</label>
                                <input type="number" step="0.01" id="lab-testosterone-free" placeholder="e.g., 1.2">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>Estradiol (pg/mL)</label>
                                <input type="number" step="0.01" id="lab-estradiol" placeholder="e.g., 59.0">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>Progesterone (ng/mL)</label>
                                <input type="number" step="0.01" id="lab-progesterone" placeholder="e.g., 0.55">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>SHBG (nmol/L)</label>
                                <input type="number" step="0.01" id="lab-shbg" placeholder="e.g., 70.92">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>Prolactin (ng/mL)</label>
                                <input type="number" step="0.01" id="lab-prolactin" placeholder="e.g., 41.55">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>DHEA-S (ug/dL)</label>
                                <input type="number" step="0.01" id="lab-dhea" placeholder="e.g., 151.8">
                            </div>
                        </div>

                        <!-- Thyroid -->
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #e9ecef;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">Thyroid</h4>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>TSH (uIU/mL)</label>
                                <input type="number" step="0.001" id="lab-tsh" placeholder="e.g., 2.525">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>Free T4 (ng/dL)</label>
                                <input type="number" step="0.01" id="lab-t4" placeholder="e.g., 0.62">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Free T3 (pg/mL)</label>
                                <input type="number" step="0.01" id="lab-t3" placeholder="e.g., 3.21">
                            </div>
                        </div>

                        <!-- Vitamins & Minerals -->
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #e9ecef;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">Vitamins & Minerals</h4>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>Vitamin D (ng/mL)</label>
                                <input type="number" step="0.01" id="lab-vitd" placeholder="e.g., 37.19">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>Vitamin B12 (pg/mL)</label>
                                <input type="number" step="0.01" id="lab-b12" placeholder="e.g., 294">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Ferritin (ng/mL)</label>
                                <input type="number" step="0.01" id="lab-ferritin" placeholder="e.g., 26.97">
                            </div>
                        </div>

                        <!-- Metabolic -->
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #e9ecef;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">Metabolic</h4>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>Glucose (mg/dL)</label>
                                <input type="number" step="0.1" id="lab-glucose" placeholder="e.g., 85">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>HbA1c (%)</label>
                                <input type="number" step="0.1" id="lab-hba1c" placeholder="e.g., 4.9">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>Total Cholesterol (mg/dL)</label>
                                <input type="number" step="1" id="lab-cholesterol" placeholder="e.g., 197">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>LDL (mg/dL)</label>
                                <input type="number" step="1" id="lab-ldl" placeholder="e.g., 120">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label>HDL (mg/dL)</label>
                                <input type="number" step="1" id="lab-hdl" placeholder="e.g., 78">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Triglycerides (mg/dL)</label>
                                <input type="number" step="1" id="lab-triglycerides" placeholder="e.g., 97">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="lab-notes" placeholder="e.g., Pre-TRT baseline, 6-week follow-up, started thyroid medication, etc."></textarea>
                    </div>
                    <button id="lab-save-btn" onclick="saveLabEntry()" class="btn">Save Lab Results</button>
                    <button id="lab-cancel-btn" onclick="cancelLabEdit()" class="btn" style="display: none; background: #6c757d;">Cancel Edit</button>
                </div>
            </div>

            <!-- Reminders Tab -->
            <div id="reminders" class="tab-content">
                <h2 style="color: #667eea; margin-bottom: 20px;">Reminders</h2>

                <div id="reminders-notification-status" class="notification-banner" style="display: none;">
                    <p id="notification-status-text"></p>
                    <button onclick="requestNotificationPermission()" class="btn btn-small" id="enable-notifications-btn">Enable</button>
                </div>

                <!-- Morning Check-In Reminder -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                    <h3 style="color: white; margin-bottom: 15px;">‚òÄÔ∏è Morning Check-In Reminder</h3>
                    <p style="opacity: 0.9; margin-bottom: 15px;">Get a daily reminder to log how you're feeling and track your recovery progress.</p>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="font-weight: bold;">Time:</label>
                            <input type="time" id="checkin-reminder-time" value="08:00" style="padding: 10px; border: none; border-radius: 8px; font-size: 1em;">
                        </div>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="checkin-reminder-enabled" checked style="width: 20px; height: 20px;">
                            <span>Enabled</span>
                        </label>
                        <button onclick="saveCheckinReminder()" class="btn" style="background: white; color: #667eea;">Save</button>
                    </div>
                    <p style="margin-top: 15px; font-size: 0.85em; opacity: 0.8;">üí° Tip: Set this for right after you take your morning Wellbutrin so you remember to log your symptoms!</p>
                </div>

                <!-- External Reminder Options -->
                <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); padding: 25px; border-radius: 15px; margin-bottom: 25px; color: white;">
                    <h3 style="color: white; margin-bottom: 15px;">üì± Want Text or Email Reminders?</h3>
                    <p style="opacity: 0.9; margin-bottom: 20px;">This app can't send texts/emails directly, but here are FREE services that can:</p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <!-- Google Calendar -->
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
                            <h4 style="color: white; margin-bottom: 10px;">üìß Email Reminders</h4>
                            <p style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">Use <strong>Google Calendar</strong> - set recurring events with email notifications:</p>
                            <ol style="margin: 0; padding-left: 20px; font-size: 0.85em; opacity: 0.9;">
                                <li>Go to calendar.google.com</li>
                                <li>Create event "TRT Shot" on Fridays</li>
                                <li>Set to repeat weekly</li>
                                <li>Add email notification</li>
                            </ol>
                            <a href="https://calendar.google.com" target="_blank" style="display: inline-block; margin-top: 10px; background: white; color: #ee5a24; padding: 8px 15px; border-radius: 8px; text-decoration: none; font-weight: bold;">Open Google Calendar</a>
                        </div>

                        <!-- Text via IFTTT -->
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
                            <h4 style="color: white; margin-bottom: 10px;">üí¨ Text Message Reminders</h4>
                            <p style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">Use <strong>IFTTT</strong> (free app) - sends texts at scheduled times:</p>
                            <ol style="margin: 0; padding-left: 20px; font-size: 0.85em; opacity: 0.9;">
                                <li>Download IFTTT app</li>
                                <li>Create "Date & Time" trigger</li>
                                <li>Set action: "Send SMS"</li>
                                <li>Schedule for shot days</li>
                            </ol>
                            <a href="https://ifttt.com/date_and_time" target="_blank" style="display: inline-block; margin-top: 10px; background: white; color: #ee5a24; padding: 8px 15px; border-radius: 8px; text-decoration: none; font-weight: bold;">Set Up IFTTT</a>
                        </div>

                        <!-- Phone Alarms -->
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
                            <h4 style="color: white; margin-bottom: 10px;">‚è∞ Phone Alarm (Simplest)</h4>
                            <p style="font-size: 0.9em; opacity: 0.9; margin-bottom: 10px;">Just use your phone's built-in alarm/reminder app:</p>
                            <ul style="margin: 0; padding-left: 20px; font-size: 0.85em; opacity: 0.9;">
                                <li><strong>iPhone:</strong> Reminders app ‚Üí New ‚Üí Repeat weekly</li>
                                <li><strong>Android:</strong> Clock app ‚Üí Alarm ‚Üí Repeat Fri</li>
                                <li>Label it "TRT SHOT DAY!"</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Your Medication Schedule</h3>
                    <div id="medication-schedule">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 25px; border-radius: 15px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">Edit Reminder Times</h3>
                    <div id="reminder-editor">
                        <!-- Populated by JS -->
                    </div>
                    <button onclick="saveReminderTimes()" class="btn" style="margin-top: 20px;">Save Reminder Times</button>
                </div>

                <!-- Backup & Restore Section -->
                <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); padding: 25px; border-radius: 15px; margin-top: 25px; color: white;">
                    <h3 style="color: white; margin-bottom: 15px;">üíæ Backup & Restore Your Data</h3>
                    <p style="opacity: 0.9; margin-bottom: 20px;">Export your data to a file for safekeeping. You can restore it anytime if something goes wrong.</p>

                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px;">
                        <button onclick="exportBackup()" class="btn" style="background: white; color: #28a745; font-weight: bold;">
                            üì• Export Backup
                        </button>
                        <label class="btn" style="background: rgba(255,255,255,0.2); color: white; cursor: pointer; font-weight: bold;">
                            üì§ Import Backup
                            <input type="file" accept=".json" onchange="importBackup(event)" style="display: none;">
                        </label>
                    </div>

                    <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px;">
                        <p style="margin: 0; font-size: 0.9em;"><strong>Tip:</strong> Export a backup weekly, especially after entering lab results! Save the file to your OneDrive or Google Drive for extra safety.</p>
                    </div>

                    <div id="backup-status" style="margin-top: 15px; display: none; padding: 10px; border-radius: 8px;"></div>
                </div>
            </div>

            <!-- Recovery Timeline Tab -->
            <div id="timeline" class="tab-content">
                <h2 style="color: #667eea; margin-bottom: 20px;">Your Recovery Timeline - Starting Today</h2>
                <p style="color: #6c757d; margin-bottom: 25px;">You stopped Wellbutrin cold turkey and crashed your dopamine system - killing sleep, motivation, and libido. You restarted 300mg XL today. Here's exactly what to expect as your brain heals.</p>

                <div class="timeline-card" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); color: white; border-left-color: #dc3545;">
                    <h3 style="color: white;">üö® What Happened When You Stopped Cold Turkey</h3>
                    <ul class="timeline-list" style="color: white;">
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Dopamine Crash</span> Wellbutrin was boosting your dopamine daily. Stopping abruptly left your brain without the support it adapted to. Result: no motivation, flat mood, "blah" feeling.</li>
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Norepinephrine Drop</span> This neurotransmitter controls alertness and energy. Without it: fatigue, can't focus, everything feels hard.</li>
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Sleep Destroyed</span> Paradoxically, even though Wellbutrin is stimulating, stopping it disrupts sleep regulation. Your brain lost its rhythm.</li>
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Libido Gone</span> Dopamine = desire. No dopamine = no interest in sex, no arousal, no motivation for anything pleasurable.</li>
                        <li style="border-bottom: none;"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Feeling Cold</span> Norepinephrine regulates body temperature. Without it: chills, cold hands/feet, can't warm up. This will normalize in 1-2 weeks.</li>
                    </ul>
                    <p style="margin-top: 15px; opacity: 0.9;"><strong>Good news:</strong> You're restarting today. Your brain will recover faster than starting fresh because those pathways already exist.</p>
                </div>

                <!-- Complete Withdrawal Symptoms Checklist -->
                <div class="timeline-card" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; border-left-color: #6c757d;">
                    <h3 style="color: white;">üìã Complete Wellbutrin Withdrawal Symptoms Checklist</h3>
                    <p style="margin-bottom: 15px; opacity: 0.9;">Check what you're experiencing. These are ALL documented withdrawal symptoms - most will resolve within 1-4 weeks of restarting.</p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                        <!-- Physical Symptoms -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                            <h4 style="color: #ffc107; margin-bottom: 10px;">‚ö° Physical Symptoms</h4>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Fatigue / exhaustion</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Headaches</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Dizziness / lightheadedness</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Nausea</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Flu-like symptoms</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Muscle aches / joint pain</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Sweating (or chills)</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Feeling cold / can't warm up</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Tremors / shaking</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Heart palpitations</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Tingling sensations</li>
                                <li style="padding: 5px 0;">‚òê Appetite changes (increased or decreased)</li>
                            </ul>
                        </div>

                        <!-- Neurological/Sensory -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                            <h4 style="color: #17a2b8; margin-bottom: 10px;">üß† Neurological / Sensory</h4>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Brain zaps / electric shock sensations</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Brain fog / confusion</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Difficulty concentrating</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Memory problems</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Sensory disturbances</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Ringing in ears (tinnitus)</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Visual disturbances</li>
                                <li style="padding: 5px 0;">‚òê Feeling "disconnected" or unreal</li>
                            </ul>
                        </div>

                        <!-- Mood/Emotional -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                            <h4 style="color: #e83e8c; margin-bottom: 10px;">üíî Mood / Emotional</h4>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Depression returning/worsening</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Anxiety / panic attacks</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Irritability / agitation</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Mood swings</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Crying spells</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Feeling "blah" / flat / empty</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Hopelessness</li>
                                <li style="padding: 5px 0;">‚òê Emotional numbness</li>
                            </ul>
                        </div>

                        <!-- Sleep Issues -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                            <h4 style="color: #6f42c1; margin-bottom: 10px;">üò¥ Sleep Issues</h4>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Insomnia / can't fall asleep</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Waking up frequently</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Early morning waking</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Vivid dreams / nightmares</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Hypersomnia (sleeping too much)</li>
                                <li style="padding: 5px 0;">‚òê Unrefreshing sleep</li>
                            </ul>
                        </div>

                        <!-- Drive/Motivation -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                            <h4 style="color: #28a745; margin-bottom: 10px;">üéØ Drive / Motivation</h4>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Zero motivation</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Loss of interest in everything</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Can't start tasks</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Loss of libido / sex drive</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê No pleasure from activities (anhedonia)</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Social withdrawal</li>
                                <li style="padding: 5px 0;">‚òê Feeling like "what's the point"</li>
                            </ul>
                        </div>

                        <!-- GI/Other -->
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                            <h4 style="color: #fd7e14; margin-bottom: 10px;">üî• GI / Other</h4>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Stomach cramps</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Diarrhea or constipation</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Dry mouth</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Weight changes</li>
                                <li style="padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">‚òê Cravings (sugar, carbs, nicotine)</li>
                                <li style="padding: 5px 0;">‚òê Restlessness / can't sit still</li>
                            </ul>
                        </div>
                    </div>

                    <p style="margin-top: 20px; opacity: 0.9; font-size: 0.9em;"><strong>Note:</strong> Severity peaks days 2-5 after stopping, then gradually improves. Restarting Wellbutrin should relieve most symptoms within 1-2 weeks. If any symptom is severe or you have thoughts of self-harm, contact your doctor immediately.</p>
                </div>

                <div class="timeline-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-left-color: #667eea;">
                    <h3 style="color: white;">üß† Motivation & "Blah" Feeling Recovery</h3>
                    <p style="margin-bottom: 15px; opacity: 0.9;">This is usually the FIRST thing to improve as Wellbutrin rebuilds dopamine.</p>
                    <ul class="timeline-list" style="color: white;">
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Days 1-3</span> Wellbutrin absorbing. You might feel slightly "off" or jittery as it kicks in. The blah feeling still there but you may notice tiny moments of clarity.</li>
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Days 4-7</span> First noticeable lift. The heavy "can't do anything" feeling starts breaking up. Small tasks feel slightly less impossible. You might actually WANT to do something.</li>
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Week 2</span> Motivation returning. The fog is lifting. You'll catch yourself initiating things instead of forcing yourself. Energy picking up noticeably.</li>
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Week 3</span> Significant improvement. The "blah" replaced by actual interest in life. Dopamine system rebuilding. You feel like yourself again.</li>
                        <li style="border-bottom: none;"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Week 4+</span> Full motivation restored. Wellbutrin at steady state. Combined with TRT = strong drive, focus, and "get it done" energy.</li>
                    </ul>
                </div>

                <div class="timeline-card sleep">
                    <h3>üò¥ Sleep Recovery (Yes, Wellbutrin Will Help)</h3>
                    <p style="margin-bottom: 15px; color: #6c757d;">Your sleep is wrecked because stopping Wellbutrin disrupted your brain chemistry. Restarting will stabilize it - but there's an adjustment period.</p>
                    <ul class="timeline-list">
                        <li><span class="week-badge">Days 1-4</span> Sleep may still be rough. Wellbutrin is stimulating so take it EARLY (before 9am). You might feel wired initially. This is temporary.</li>
                        <li><span class="week-badge">Days 5-10</span> Sleep starting to regulate. Your brain is adjusting to consistent dopamine again. May still wake up early but falling asleep gets easier.</li>
                        <li><span class="week-badge">Week 2</span> Noticeable improvement. The chaos is settling. You're getting more continuous sleep. Less lying awake with racing thoughts.</li>
                        <li><span class="week-badge">Week 3</span> Sleep architecture normalizing. Deeper sleep, fewer wake-ups. The norepinephrine is helping regulate your sleep-wake cycle properly.</li>
                        <li><span class="week-badge">Week 4+</span> Sleep stabilized. Most women sleep WELL on Wellbutrin once adjusted - it's not like SSRIs that wreck sleep long-term. TRT also supports healthy sleep.</li>
                    </ul>
                    <p style="margin-top: 15px; padding: 15px; background: rgba(63,81,181,0.1); border-radius: 10px;">
                        <strong>Critical tips:</strong> Take Wellbutrin before 9am. No caffeine after noon. Magnesium glycinate 400mg before bed. Keep consistent wake time even if sleep is rough - this helps your brain reset faster.
                    </p>
                </div>

                <div class="timeline-card libido">
                    <h3>üî• Libido Recovery - Wellbutrin + TRT Combined</h3>
                    <p style="margin-bottom: 15px; color: #6c757d;">Libido requires dopamine (desire/wanting) + testosterone (physical arousal). You're rebuilding both.</p>
                    <ul class="timeline-list">
                        <li><span class="week-badge">Week 1</span> Still flat. Dopamine just starting to rise. Don't expect much yet - your brain needs time to rebuild. TRT working in background.</li>
                        <li><span class="week-badge">Week 2</span> First sparks. You might notice a sexual thought, a flicker of interest. Not strong yet but it's coming back online. This is a good sign.</li>
                        <li><span class="week-badge">Week 3</span> Interest returning. The "I could take it or leave it" shifts to actually wanting intimacy. Arousal response starting to work again.</li>
                        <li><span class="week-badge">Week 4</span> Wellbutrin at steady state. Libido noticeably improved. TRT also hitting its stride. Physical sensitivity increasing. Orgasms possible/better.</li>
                        <li><span class="week-badge">Week 5-6</span> Significant recovery. Sexual thoughts happening spontaneously. Desire feels natural again, not forced. The combination is working.</li>
                        <li><span class="week-badge">Week 8+</span> Full libido recovery - often BETTER than before because Wellbutrin + TRT together are powerful for women's sexuality.</li>
                    </ul>
                    <p style="margin-top: 15px; padding: 15px; background: rgba(233,30,99,0.1); border-radius: 10px;">
                        <strong>Why this combo works:</strong> Wellbutrin increases dopamine (the "wanting" part of desire). TRT increases testosterone (physical arousal, sensitivity, orgasm intensity). Together they hit both pathways.
                    </p>
                </div>

                <div class="timeline-card hormones">
                    <h3>üíâ TRT Stabilization (Running Parallel)</h3>
                    <p style="margin-bottom: 15px; color: #6c757d;">Your TRT keeps building while Wellbutrin restarts. They'll sync up around week 4-6 for maximum benefit.</p>
                    <ul class="timeline-list">
                        <li><span class="week-badge">Week 1-2</span> TRT continuing to build. Provides baseline support while Wellbutrin ramps up. Subtle energy help even when dopamine is low.</li>
                        <li><span class="week-badge">Week 3-4</span> Testosterone levels stabilizing. Mental clarity improving. Starting to amplify Wellbutrin's effects on motivation and mood.</li>
                        <li><span class="week-badge">Week 5-6</span> TRT and Wellbutrin both optimized. This is when you feel the synergy - energy, motivation, libido all clicking together.</li>
                        <li><span class="week-badge">Week 8-12</span> Peak optimization. Get labs: Total T, Free T, Estradiol, SHBG. Adjust TRT dose if needed based on how you feel + numbers.</li>
                    </ul>
                    <p style="margin-top: 15px; padding: 15px; background: rgba(156,39,176,0.1); border-radius: 10px;">
                        <strong>Keep your Friday shots consistent.</strong> Stable testosterone = stable mood and energy. Don't skip doses while your system is recovering.
                    </p>
                </div>

                <div class="timeline-card nad">
                    <h3>‚ö° NAD+ - When to Start & Why It Wasn't Working</h3>
                    <p style="margin-bottom: 15px; color: #6c757d;">NAD+ wasn't doing much because it supports dopamine PRODUCTION - but without Wellbutrin, your brain wasn't using that dopamine properly. Now that you're restarting Wellbutrin, NAD+ will actually help.</p>
                    <ul class="timeline-list">
                        <li><span class="week-badge">START NOW</span> Begin NAD+ this Monday (or ASAP). It will help accelerate Wellbutrin's effects by supporting the enzymes that produce dopamine and norepinephrine.</li>
                        <li><span class="week-badge">Week 1</span> NAD+ providing cellular energy while Wellbutrin ramps up. You'll feel less "crashed" during the transition than you would without it.</li>
                        <li><span class="week-badge">Week 2</span> The synergy kicks in. NAD+ is now boosting the dopamine that Wellbutrin is helping your brain use. Mental clarity improving faster.</li>
                        <li><span class="week-badge">Week 3-4</span> Full benefit. NAD+ + Wellbutrin + TRT all working together. Brain fog gone, energy stable, motivation strong.</li>
                    </ul>
                    <p style="margin-top: 15px; padding: 15px; background: rgba(255,152,0,0.1); border-radius: 10px;">
                        <strong>Why it didn't work before:</strong> NAD+ helps your cells MAKE neurotransmitters. But Wellbutrin helps your brain USE them effectively. Without Wellbutrin, you were making dopamine but it wasn't being utilized - like filling a tank with gas but having no engine. Now you have both.
                    </p>
                    <p style="margin-top: 10px; padding: 15px; background: rgba(255,152,0,0.2); border-radius: 10px;">
                        <strong>Recommendation:</strong> Do 2x/week NAD+ for the first 4 weeks of your Wellbutrin restart. This will maximize recovery speed. Then you can drop back to 1x/week maintenance.
                    </p>
                </div>

                <div class="timeline-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border-left-color: #28a745;">
                    <h3 style="color: white;">üìä What to Track Daily During Recovery</h3>
                    <ul class="timeline-list" style="color: white;">
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Motivation</span> Rate 1-10. This improves first - look for upward trend by day 5-7. Note if you're initiating tasks vs forcing yourself.</li>
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Sleep</span> Hours + quality. Track time to fall asleep, wake-ups, morning energy. Expect improvement by week 2-3.</li>
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Energy</span> Morning vs afternoon. Wellbutrin should boost this by week 1-2. Note crashes or jitters.</li>
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Mood</span> Overall outlook. The "blah" should lift by week 2. Note any irritability (common early on, settles down).</li>
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Libido</span> Rate 1-10. This comes back last - be patient. Look for first sparks around week 2, real improvement week 4+.</li>
                        <li style="border-bottom: none;"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Side Effects</span> Dry mouth, appetite changes, headaches are normal at first. They usually resolve by week 2-3.</li>
                    </ul>
                </div>

                <div class="timeline-card" style="background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%); color: white; border-left-color: #17a2b8;">
                    <h3 style="color: white;">üí™ The Order Things Come Back</h3>
                    <ul class="timeline-list" style="color: white;">
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">First (Days 4-7)</span> <strong>Energy & motivation</strong> - The "blah" starts lifting. You feel slightly more alive.</li>
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Second (Week 2)</span> <strong>Mood & focus</strong> - Brain fog clears. You feel more like yourself. Interest in things returns.</li>
                        <li style="border-bottom-color: rgba(255,255,255,0.2);"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Third (Week 2-3)</span> <strong>Sleep</strong> - Falls into rhythm. Deeper, more restorative. Morning energy improves.</li>
                        <li style="border-bottom: none;"><span class="week-badge" style="background: rgba(255,255,255,0.3);">Last (Week 4-6)</span> <strong>Libido</strong> - Requires full dopamine recovery + TRT synergy. Be patient - it's coming.</li>
                    </ul>
                    <p style="margin-top: 15px; opacity: 0.9;"><strong>Remember:</strong> You're not starting from zero. Your brain has the pathways - they just need to wake back up. Recovery is typically faster the second time.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Entry Modal -->
    <div class="modal-overlay" id="day-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-date-title">Daily Check-In</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Medications Section -->
                <div class="modal-section">
                    <h3>Medications & Supplements</h3>
                    <div class="med-checklist" id="modal-med-checklist">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Sleep Section -->
                <div class="modal-section">
                    <div class="sleep-section">
                        <h3>Sleep Tracking</h3>
                        <div class="sleep-grid">
                            <div class="sleep-input">
                                <label>Hours Slept</label>
                                <input type="number" id="modal-sleep-hours" min="0" max="24" step="0.5" placeholder="7.5">
                            </div>
                            <div class="sleep-input">
                                <label>Quality (1-10)</label>
                                <input type="number" id="modal-sleep-quality" min="1" max="10" placeholder="7">
                            </div>
                            <div class="sleep-input">
                                <label>Mins to Fall Asleep</label>
                                <input type="number" id="modal-sleep-fallasleep" min="0" placeholder="15">
                            </div>
                            <div class="sleep-input">
                                <label>Wake-ups</label>
                                <input type="number" id="modal-sleep-wakeups" min="0" placeholder="1">
                            </div>
                            <div class="sleep-input">
                                <label>Morning Energy (1-10)</label>
                                <input type="number" id="modal-sleep-energy" min="1" max="10" placeholder="6">
                            </div>
                            <div class="sleep-input">
                                <label>Sleep Aid Used?</label>
                                <select id="modal-sleep-aid">
                                    <option value="">None</option>
                                    <option value="melatonin">Melatonin</option>
                                    <option value="magnesium">Magnesium</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <label style="color: #a8d8ea; font-size: 0.85em; display: block; margin-bottom: 8px;">Sleep Notes / Dreams</label>
                            <textarea id="modal-sleep-notes" placeholder="Any dreams, disturbances, or notes about sleep..." style="background: rgba(255,255,255,0.9);"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Symptoms Section -->
                <div class="modal-section">
                    <h3>How Are You Feeling?</h3>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Motivation (want to do things?)</span>
                            <span class="slider-value" id="modal-motivation-value">5</span>
                        </div>
                        <input type="range" min="1" max="10" value="5" id="modal-motivation" oninput="updateModalSlider('motivation')">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Energy Level</span>
                            <span class="slider-value" id="modal-energy-value">5</span>
                        </div>
                        <input type="range" min="1" max="10" value="5" id="modal-energy" oninput="updateModalSlider('energy')">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Mood</span>
                            <span class="slider-value" id="modal-mood-value">5</span>
                        </div>
                        <input type="range" min="1" max="10" value="5" id="modal-mood" oninput="updateModalSlider('mood')">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Libido</span>
                            <span class="slider-value" id="modal-libido-value">5</span>
                        </div>
                        <input type="range" min="1" max="10" value="5" id="modal-libido" oninput="updateModalSlider('libido')">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Mental Clarity (brain fog?)</span>
                            <span class="slider-value" id="modal-clarity-value">5</span>
                        </div>
                        <input type="range" min="1" max="10" value="5" id="modal-clarity" oninput="updateModalSlider('clarity')">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Anxiety (1=none, 10=severe)</span>
                            <span class="slider-value" id="modal-anxiety-value">3</span>
                        </div>
                        <input type="range" min="1" max="10" value="3" id="modal-anxiety" oninput="updateModalSlider('anxiety')">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Overall Well-being</span>
                            <span class="slider-value" id="modal-wellbeing-value">5</span>
                        </div>
                        <input type="range" min="1" max="10" value="5" id="modal-wellbeing" oninput="updateModalSlider('wellbeing')">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Body Temperature (1=freezing, 5=normal, 10=hot/sweating)</span>
                            <span class="slider-value" id="modal-temperature-value">5</span>
                        </div>
                        <input type="range" min="1" max="10" value="5" id="modal-temperature" oninput="updateModalSlider('temperature')">
                    </div>
                </div>

                <!-- Wellbutrin Side Effects Section -->
                <div class="modal-section">
                    <h3>Wellbutrin Side Effects (check any you're experiencing)</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="modal-se-drymouth" style="width: 18px; height: 18px;">
                            <span>Dry mouth</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="modal-se-appetite" style="width: 18px; height: 18px;">
                            <span>Appetite changes</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="modal-se-headache" style="width: 18px; height: 18px;">
                            <span>Headache</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="modal-se-jitters" style="width: 18px; height: 18px;">
                            <span>Jitters/restless</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="modal-se-insomnia" style="width: 18px; height: 18px;">
                            <span>Insomnia</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="modal-se-nausea" style="width: 18px; height: 18px;">
                            <span>Nausea</span>
                        </label>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="modal-section">
                    <h3>Notes</h3>
                    <textarea id="modal-notes" placeholder="Any other observations or notes..."></textarea>
                </div>

                <button onclick="saveModalEntry()" class="btn">Save Entry</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ============ DATA STRUCTURE ============
        let appData = {
            medications: [
                { id: 'trt', name: 'TRT Shot', emoji: 'üíâ', schedule: 'weekly', days: [5], time: null, reminderEnabled: true },
                { id: 'nad', name: 'NAD+ Shot', emoji: 'üíâ', schedule: 'weekly', days: [1], time: null, reminderEnabled: true },
                { id: 'wellbutrin', name: 'Wellbutrin 300mg', emoji: 'üíä', schedule: 'daily', days: [], time: '08:00', reminderEnabled: true },
                { id: 'multivitamin', name: 'One A Day', emoji: 'üíä', schedule: 'daily', days: [], time: '08:00', reminderEnabled: true },
                { id: 'iron', name: 'Iron', emoji: 'üíä', schedule: 'daily', days: [], time: '14:00', reminderEnabled: true },
                { id: 'vitc', name: 'Vitamin C', emoji: 'üíä', schedule: 'daily', days: [], time: '14:00', reminderEnabled: true }
            ],
            dailyLogs: {},
            tapering: {
                medication: 'Wellbutrin',
                currentDose: 300,
                schedule: [
                    { dose: 300, weeks: 4, startDate: null },
                    { dose: 150, weeks: 4, startDate: null },
                    { dose: 75, weeks: 2, startDate: null },
                    { dose: 0, weeks: 0, startDate: null }
                ],
                started: false,
                startDate: null,
                symptoms: []
            },
            labResults: [],
            checkinReminder: {
                enabled: true,
                time: '08:00'
            },
            wellbutrinRestartDate: null,
            trtStartDate: '2025-11-25',
            nadStartDate: '2025-12-26',
            settings: {
                notificationsEnabled: false
            }
        };

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = null;
        let sleepChart = null;
        let labChart = null;
        let symptomChart = null;
        let trtMiniChart = null;
        let nadMiniChart = null;
        let editingLabIndex = null; // Track which lab entry we're editing
        let reminderIntervals = [];

        // ============ INITIALIZATION ============
        function init() {
            loadData();
            loadWellbutrinRestartDate();
            renderCalendar();
            renderTodayMeds();
            updateStats();
            checkNotificationPermission();
            setupReminders();
            loadCheckinReminderSettings();
            updateShotDashboard();
            renderTrtMiniChart();
            renderNadMiniChart();

            // Set today's date display
            refreshTodayDisplay();

            // Set default dates for inputs using local time (not UTC)
            const today = formatDateKey(new Date());
            document.getElementById('withdrawal-date').value = today;
            document.getElementById('lab-date').value = today;
            document.getElementById('taper-start-date').value = today;

            // Restore last tab from localStorage
            const savedTab = localStorage.getItem('wellnessTracker_currentTab');
            if (savedTab) {
                switchTab(savedTab);
            }

            // Refresh date display when app becomes visible (e.g., after sleep or switching tabs)
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') {
                    refreshTodayDisplay();
                }
            });

            // Also refresh on window focus (for PWA)
            window.addEventListener('focus', refreshTodayDisplay);

            // Check for date change every minute
            setInterval(refreshTodayDisplay, 60000);
        }

        // Refresh today's date display and related UI
        let lastDisplayedDate = null;
        function refreshTodayDisplay() {
            const currentDate = formatDateKey(new Date());

            // Only refresh if date actually changed
            if (lastDisplayedDate !== currentDate) {
                lastDisplayedDate = currentDate;
                document.getElementById('today-date').textContent = formatDate(new Date());
                renderTodayMeds();
                renderCalendar();
                updateShotDashboard();
                console.log('Date refreshed to:', currentDate);
            }
        }

        // ============ DATA PERSISTENCE ============
        function loadData() {
            const saved = localStorage.getItem('wellnessTracker_v1');
            if (saved) {
                const parsed = JSON.parse(saved);
                appData = { ...appData, ...parsed };
                // Ensure medications array has all required meds
                const defaultMeds = [
                    { id: 'trt', name: 'TRT Shot', emoji: 'üíâ', schedule: 'weekly', days: [5], time: null, reminderEnabled: true },
                    { id: 'nad', name: 'NAD+ Shot', emoji: 'üíâ', schedule: 'weekly', days: [1], time: null, reminderEnabled: true },
                    { id: 'wellbutrin', name: 'Wellbutrin 300mg', emoji: 'üíä', schedule: 'daily', days: [], time: '08:00', reminderEnabled: true },
                    { id: 'multivitamin', name: 'One A Day', emoji: 'üíä', schedule: 'daily', days: [], time: '08:00', reminderEnabled: true },
                    { id: 'iron', name: 'Iron', emoji: 'üíä', schedule: 'daily', days: [], time: '14:00', reminderEnabled: true },
                    { id: 'vitc', name: 'Vitamin C', emoji: 'üíä', schedule: 'daily', days: [], time: '14:00', reminderEnabled: true }
                ];
                defaultMeds.forEach(med => {
                    if (!appData.medications.find(m => m.id === med.id)) {
                        appData.medications.push(med);
                    }
                });
            }

        }

        function saveData() {
            localStorage.setItem('wellnessTracker_v1', JSON.stringify(appData));
        }

        // ============ BACKUP & RESTORE ============
        function exportBackup() {
            const dataStr = JSON.stringify(appData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const today = new Date();
            const dateStr = today.getFullYear() + '-' +
                String(today.getMonth() + 1).padStart(2, '0') + '-' +
                String(today.getDate()).padStart(2, '0');

            const a = document.createElement('a');
            a.href = url;
            a.download = `wellness-tracker-backup-${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showBackupStatus('Backup exported successfully!', 'success');
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // Validate the data has expected structure
                    if (!importedData.medications || !importedData.dailyLogs) {
                        throw new Error('Invalid backup file format');
                    }

                    // Confirm before overwriting
                    const logCount = Object.keys(importedData.dailyLogs).length;
                    const labCount = importedData.labResults ? importedData.labResults.length : 0;

                    if (confirm(`This will restore:\n- ${logCount} daily logs\n- ${labCount} lab results\n\nThis will REPLACE all current data. Continue?`)) {
                        appData = importedData;
                        saveData();

                        // Refresh everything
                        renderCalendar();
                        renderTodayMeds();
                        updateStats();
                        updateShotDashboard();
                        renderTrtMiniChart();
                        renderNadMiniChart();

                        showBackupStatus(`Restored ${logCount} daily logs and ${labCount} lab results!`, 'success');
                    }
                } catch (error) {
                    showBackupStatus('Error: Invalid backup file. Please select a valid backup.', 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);

            // Reset the input so the same file can be selected again
            event.target.value = '';
        }

        function showBackupStatus(message, type) {
            const status = document.getElementById('backup-status');
            if (status) {
                status.style.display = 'block';
                status.style.background = type === 'success' ? 'rgba(255,255,255,0.3)' : 'rgba(220,53,69,0.5)';
                status.textContent = message;

                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        // ============ TAB NAVIGATION ============
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Save current tab to localStorage
            localStorage.setItem('wellnessTracker_currentTab', tabId);

            // Initialize tab-specific content
            if (tabId === 'history') {
                renderHistory();
                loadWellbutrinRestartDate();
                loadChartCheckboxes();
                renderSymptomChart();
                updateSymptomStats();
            } else if (tabId === 'sleep') {
                renderSleepChart();
                updateSleepStats();
            } else if (tabId === 'tapering') {
                renderTaperingTab();
            } else if (tabId === 'labs') {
                renderLabsTab();
            } else if (tabId === 'reminders') {
                renderRemindersTab();
            }
        }

        function saveChartCheckboxes() {
            const checkboxIds = ['motivation', 'energy', 'mood', 'libido', 'clarity', 'anxiety', 'wellbeing', 'temperature'];
            const states = {};
            checkboxIds.forEach(id => {
                const checkbox = document.getElementById(`chart-${id}`);
                if (checkbox) {
                    states[id] = checkbox.checked;
                }
            });
            localStorage.setItem('wellnessTracker_chartCheckboxes', JSON.stringify(states));
        }

        function loadChartCheckboxes() {
            const saved = localStorage.getItem('wellnessTracker_chartCheckboxes');
            if (saved) {
                const states = JSON.parse(saved);
                Object.keys(states).forEach(id => {
                    const checkbox = document.getElementById(`chart-${id}`);
                    if (checkbox) {
                        checkbox.checked = states[id];
                    }
                });
            }
        }

        // ============ CALENDAR ============
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];

            document.getElementById('calendar-month-year').textContent = `${monthNames[currentMonth]} ${currentYear}`;

            // Clear grid
            grid.innerHTML = '';

            // Add day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // Get first day of month and total days
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const dayNum = daysInPrevMonth - i;
                const dayEl = createDayElement(dayNum, true, new Date(currentYear, currentMonth - 1, dayNum));
                grid.appendChild(dayEl);
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const isToday = date.getTime() === today.getTime();
                const dayEl = createDayElement(day, false, date, isToday);
                grid.appendChild(dayEl);
            }

            // Next month days to fill grid
            const totalCells = grid.children.length;
            const remainingCells = 42 - totalCells + 7; // 6 rows * 7 days + 7 headers
            for (let day = 1; day <= remainingCells && totalCells < 49; day++) {
                const dayEl = createDayElement(day, true, new Date(currentYear, currentMonth + 1, day));
                grid.appendChild(dayEl);
            }
        }

        function createDayElement(dayNum, isOtherMonth, date, isToday = false) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            if (isOtherMonth) dayEl.classList.add('other-month');
            if (isToday) dayEl.classList.add('today');

            const dateStr = formatDateKey(date);
            const log = appData.dailyLogs[dateStr];
            const scheduledMeds = getMedsForDate(date);

            // Get notes preview (truncate to ~25 chars)
            const notesPreview = log && log.notes ? (log.notes.length > 100 ? log.notes.substring(0, 100) + '...' : log.notes) : '';

            dayEl.innerHTML = `
                <div class="day-number">${dayNum}</div>
                <div class="day-indicators">${getDayIndicators(date, log, scheduledMeds)}</div>
                ${notesPreview ? `<div class="day-notes">üìù ${notesPreview}</div>` : ''}
                ${log && !notesPreview ? `<div class="day-status">${getCompletionStatus(log, scheduledMeds)}</div>` : ''}
            `;

            dayEl.onclick = () => openDayModal(date);

            return dayEl;
        }

        function getDayIndicators(date, log, scheduledMeds) {
            if (!log) {
                // Check if date is in the future
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (date > today) {
                    return scheduledMeds.map(() => '<div class="day-dot pending"></div>').join('');
                }
                return scheduledMeds.map(() => '<div class="day-dot missed"></div>').join('');
            }

            return scheduledMeds.map(med => {
                const taken = log.medications && log.medications[med.id];
                return `<div class="day-dot ${taken ? 'completed' : 'missed'}"></div>`;
            }).join('');
        }

        function getCompletionStatus(log, scheduledMeds) {
            if (!log || !log.medications) return '';
            const taken = scheduledMeds.filter(m => log.medications[m.id]).length;
            const total = scheduledMeds.length;
            if (taken === total) return '‚úì';
            return `${taken}/${total}`;
        }

        function getMedsForDate(date) {
            const dayOfWeek = date.getDay();
            return appData.medications.filter(med => {
                if (med.schedule === 'daily') return true;
                if (med.schedule === 'weekly') return med.days.includes(dayOfWeek);
                return false;
            });
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        }

        function goToToday() {
            const today = new Date();
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
            renderCalendar();
        }

        // ============ TODAY'S MEDS ============
        function renderTodayMeds() {
            const container = document.getElementById('today-meds');
            const today = new Date();
            const dateStr = formatDateKey(today);
            const log = appData.dailyLogs[dateStr] || { medications: {} };
            const todayMeds = getMedsForDate(today);

            container.innerHTML = todayMeds.map(med => {
                const taken = log.medications && log.medications[med.id];
                return `
                    <div class="med-item ${taken ? 'taken' : ''}" onclick="toggleTodayMed('${med.id}')">
                        <input type="checkbox" ${taken ? 'checked' : ''} onclick="event.stopPropagation(); toggleTodayMed('${med.id}')">
                        <div class="med-info">
                            <div class="med-name">${med.emoji} ${med.name}</div>
                            <div class="med-time">${med.time || (med.schedule === 'weekly' ? getDayName(med.days[0]) : 'Daily')}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleTodayMed(medId) {
            const today = formatDateKey(new Date());
            if (!appData.dailyLogs[today]) {
                appData.dailyLogs[today] = {
                    medications: {},
                    sleep: {},
                    symptoms: {},
                    notes: ''
                };
            }

            appData.dailyLogs[today].medications[medId] = !appData.dailyLogs[today].medications[medId];
            saveData();
            renderTodayMeds();
            renderCalendar();
            updateStats();
        }

        // ============ DAY MODAL ============
        function openDayModal(date) {
            selectedDate = date;
            const dateStr = formatDateKey(date);
            const log = appData.dailyLogs[dateStr];
            const scheduledMeds = getMedsForDate(date);
            const scheduledIds = scheduledMeds.map(m => m.id);
            const otherMeds = appData.medications.filter(m => !scheduledIds.includes(m.id));

            document.getElementById('modal-date-title').textContent = `Check-In: ${formatDate(date)}`;

            // Populate medications checklist - scheduled meds first
            const medChecklist = document.getElementById('modal-med-checklist');
            const injectionMeds = ['trt', 'nad']; // Meds that need injection site tracking
            let html = scheduledMeds.map(med => {
                const taken = log && log.medications && log.medications[med.id];
                const injectionSite = log && log.injectionSites && log.injectionSites[med.id] || '';
                const isInjection = injectionMeds.includes(med.id);
                return `
                    <label class="med-check-item ${taken ? 'checked' : ''}">
                        <input type="checkbox" id="modal-med-${med.id}" ${taken ? 'checked' : ''}
                               onchange="this.parentElement.classList.toggle('checked')${isInjection ? '; toggleInjectionSite(\'' + med.id + '\', this.checked)' : ''}">
                        <div class="med-details">
                            <div class="med-name">${med.emoji} ${med.name}</div>
                            <div class="med-schedule">${med.time || (med.schedule === 'weekly' ? getDayName(med.days[0]) + 's' : 'Daily')}</div>
                            ${isInjection ? `
                            <div class="injection-site-row" id="injection-site-${med.id}" style="display: ${taken ? 'flex' : 'none'}; align-items: center; gap: 8px; margin-top: 6px;">
                                <span style="font-size: 0.8em; color: #666;">Side:</span>
                                <select id="modal-site-${med.id}" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.85em; background: white;" onclick="event.stopPropagation()">
                                    <option value="">Select...</option>
                                    <option value="left" ${injectionSite === 'left' ? 'selected' : ''}>Left Side</option>
                                    <option value="right" ${injectionSite === 'right' ? 'selected' : ''}>Right Side</option>
                                </select>
                            </div>
                            ` : ''}
                        </div>
                    </label>
                `;
            }).join('');

            // Add "Other medications" section for non-scheduled meds
            if (otherMeds.length > 0) {
                html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ddd;">
                    <div style="font-size: 0.85em; color: #6c757d; margin-bottom: 10px;">üìå Not scheduled today, but taken anyway:</div>`;
                html += otherMeds.map(med => {
                    const taken = log && log.medications && log.medications[med.id];
                    const injectionSite = log && log.injectionSites && log.injectionSites[med.id] || '';
                    const isInjection = injectionMeds.includes(med.id);
                    return `
                        <label class="med-check-item ${taken ? 'checked' : ''}" style="opacity: ${taken ? '1' : '0.7'};">
                            <input type="checkbox" id="modal-med-${med.id}" ${taken ? 'checked' : ''}
                                   onchange="this.parentElement.classList.toggle('checked'); this.parentElement.style.opacity = this.checked ? '1' : '0.7';${isInjection ? ' toggleInjectionSite(\'' + med.id + '\', this.checked)' : ''}">
                            <div class="med-details">
                                <div class="med-name">${med.emoji} ${med.name}</div>
                                <div class="med-schedule" style="color: #fd7e14;">(Usually ${med.schedule === 'weekly' ? getDayName(med.days[0]) + 's' : 'Daily'})</div>
                                ${isInjection ? `
                                <div class="injection-site-row" id="injection-site-${med.id}" style="display: ${taken ? 'flex' : 'none'}; align-items: center; gap: 8px; margin-top: 6px;">
                                    <span style="font-size: 0.8em; color: #666;">Side:</span>
                                    <select id="modal-site-${med.id}" style="padding: 4px 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.85em; background: white;" onclick="event.stopPropagation()">
                                        <option value="">Select...</option>
                                        <option value="left" ${injectionSite === 'left' ? 'selected' : ''}>Left Side</option>
                                        <option value="right" ${injectionSite === 'right' ? 'selected' : ''}>Right Side</option>
                                    </select>
                                </div>
                                ` : ''}
                            </div>
                        </label>
                    `;
                }).join('');
                html += `</div>`;
            }

            medChecklist.innerHTML = html;

            // Populate sleep data
            if (log && log.sleep) {
                document.getElementById('modal-sleep-hours').value = log.sleep.hours || '';
                document.getElementById('modal-sleep-quality').value = log.sleep.quality || '';
                document.getElementById('modal-sleep-fallasleep').value = log.sleep.fallAsleep || '';
                document.getElementById('modal-sleep-wakeups').value = log.sleep.wakeups || '';
                document.getElementById('modal-sleep-energy').value = log.sleep.morningEnergy || '';
                document.getElementById('modal-sleep-aid').value = log.sleep.aid || '';
                document.getElementById('modal-sleep-notes').value = log.sleep.notes || '';
            } else {
                document.getElementById('modal-sleep-hours').value = '';
                document.getElementById('modal-sleep-quality').value = '';
                document.getElementById('modal-sleep-fallasleep').value = '';
                document.getElementById('modal-sleep-wakeups').value = '';
                document.getElementById('modal-sleep-energy').value = '';
                document.getElementById('modal-sleep-aid').value = '';
                document.getElementById('modal-sleep-notes').value = '';
            }

            // Populate symptoms
            if (log && log.symptoms) {
                ['motivation', 'energy', 'mood', 'libido', 'clarity', 'anxiety', 'wellbeing', 'temperature'].forEach(symptom => {
                    const val = log.symptoms[symptom] || (symptom === 'anxiety' ? 3 : 5);
                    document.getElementById(`modal-${symptom}`).value = val;
                    document.getElementById(`modal-${symptom}-value`).textContent = val;
                });
            } else {
                ['motivation', 'energy', 'mood', 'libido', 'clarity', 'wellbeing', 'temperature'].forEach(symptom => {
                    document.getElementById(`modal-${symptom}`).value = 5;
                    document.getElementById(`modal-${symptom}-value`).textContent = 5;
                });
                document.getElementById('modal-anxiety').value = 3;
                document.getElementById('modal-anxiety-value').textContent = 3;
            }

            // Populate side effects
            if (log && log.sideEffects) {
                document.getElementById('modal-se-drymouth').checked = log.sideEffects.dryMouth || false;
                document.getElementById('modal-se-appetite').checked = log.sideEffects.appetite || false;
                document.getElementById('modal-se-headache').checked = log.sideEffects.headache || false;
                document.getElementById('modal-se-jitters').checked = log.sideEffects.jitters || false;
                document.getElementById('modal-se-insomnia').checked = log.sideEffects.insomnia || false;
                document.getElementById('modal-se-nausea').checked = log.sideEffects.nausea || false;
            } else {
                document.getElementById('modal-se-drymouth').checked = false;
                document.getElementById('modal-se-appetite').checked = false;
                document.getElementById('modal-se-headache').checked = false;
                document.getElementById('modal-se-jitters').checked = false;
                document.getElementById('modal-se-insomnia').checked = false;
                document.getElementById('modal-se-nausea').checked = false;
            }

            // Populate notes
            document.getElementById('modal-notes').value = log && log.notes ? log.notes : '';

            document.getElementById('day-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('day-modal').classList.remove('active');
            selectedDate = null;
        }

        function updateModalSlider(id) {
            const val = document.getElementById(`modal-${id}`).value;
            document.getElementById(`modal-${id}-value`).textContent = val;
        }

        function toggleInjectionSite(medId, show) {
            const siteRow = document.getElementById(`injection-site-${medId}`);
            if (siteRow) {
                siteRow.style.display = show ? 'flex' : 'none';
            }
        }

        function saveModalEntry() {
            if (!selectedDate) return;

            const dateStr = formatDateKey(selectedDate);
            const scheduledMeds = getMedsForDate(selectedDate);

            const entry = {
                medications: {},
                sleep: {
                    hours: parseFloat(document.getElementById('modal-sleep-hours').value) || null,
                    quality: parseInt(document.getElementById('modal-sleep-quality').value) || null,
                    fallAsleep: parseInt(document.getElementById('modal-sleep-fallasleep').value) || null,
                    wakeups: parseInt(document.getElementById('modal-sleep-wakeups').value) || null,
                    morningEnergy: parseInt(document.getElementById('modal-sleep-energy').value) || null,
                    aid: document.getElementById('modal-sleep-aid').value || null,
                    notes: document.getElementById('modal-sleep-notes').value || ''
                },
                symptoms: {
                    motivation: parseInt(document.getElementById('modal-motivation').value),
                    energy: parseInt(document.getElementById('modal-energy').value),
                    mood: parseInt(document.getElementById('modal-mood').value),
                    libido: parseInt(document.getElementById('modal-libido').value),
                    clarity: parseInt(document.getElementById('modal-clarity').value),
                    anxiety: parseInt(document.getElementById('modal-anxiety').value),
                    wellbeing: parseInt(document.getElementById('modal-wellbeing').value),
                    temperature: parseInt(document.getElementById('modal-temperature').value)
                },
                sideEffects: {
                    dryMouth: document.getElementById('modal-se-drymouth').checked,
                    appetite: document.getElementById('modal-se-appetite').checked,
                    headache: document.getElementById('modal-se-headache').checked,
                    jitters: document.getElementById('modal-se-jitters').checked,
                    insomnia: document.getElementById('modal-se-insomnia').checked,
                    nausea: document.getElementById('modal-se-nausea').checked
                },
                notes: document.getElementById('modal-notes').value
            };

            // Gather medication statuses (ALL medications, not just scheduled)
            const injectionMeds = ['trt', 'nad'];
            entry.injectionSites = {};

            appData.medications.forEach(med => {
                const checkbox = document.getElementById(`modal-med-${med.id}`);
                if (checkbox) {
                    entry.medications[med.id] = checkbox.checked;

                    // Save injection site if applicable
                    if (injectionMeds.includes(med.id) && checkbox.checked) {
                        const siteSelect = document.getElementById(`modal-site-${med.id}`);
                        if (siteSelect && siteSelect.value) {
                            entry.injectionSites[med.id] = siteSelect.value;
                        }
                    }
                }
            });

            appData.dailyLogs[dateStr] = entry;
            saveData();

            closeModal();
            renderCalendar();
            renderTodayMeds();
            updateStats();
            updateShotDashboard();
            renderTrtMiniChart();
            renderNadMiniChart();
        }

        // ============ STATS ============
        function updateStats() {
            // Calculate streak
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateStr = formatDateKey(checkDate);
                const log = appData.dailyLogs[dateStr];
                const meds = getMedsForDate(checkDate);

                if (log && meds.length > 0) {
                    const allTaken = meds.every(m => log.medications && log.medications[m.id]);
                    if (allTaken) {
                        streak++;
                    } else {
                        break;
                    }
                } else if (i > 0) {
                    break;
                }
            }
            document.getElementById('stat-streak').textContent = streak;

            // Calculate week compliance
            let weekTotal = 0;
            let weekTaken = 0;
            for (let i = 0; i < 7; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateStr = formatDateKey(checkDate);
                const log = appData.dailyLogs[dateStr];
                const meds = getMedsForDate(checkDate);

                weekTotal += meds.length;
                if (log && log.medications) {
                    weekTaken += meds.filter(m => log.medications[m.id]).length;
                }
            }
            const compliance = weekTotal > 0 ? Math.round((weekTaken / weekTotal) * 100) : 0;
            document.getElementById('stat-week-compliance').textContent = compliance + '%';

            // Calculate avg sleep
            const recentLogs = Object.values(appData.dailyLogs).slice(-14);
            const sleepHours = recentLogs.filter(l => l.sleep && l.sleep.hours).map(l => l.sleep.hours);
            const avgSleep = sleepHours.length > 0 ? (sleepHours.reduce((a, b) => a + b, 0) / sleepHours.length).toFixed(1) : '-';
            document.getElementById('stat-avg-sleep').textContent = avgSleep;

            // Calculate avg energy
            const energyScores = recentLogs.filter(l => l.symptoms && l.symptoms.energy).map(l => l.symptoms.energy);
            const avgEnergy = energyScores.length > 0 ? (energyScores.reduce((a, b) => a + b, 0) / energyScores.length).toFixed(1) : '-';
            document.getElementById('stat-avg-energy').textContent = avgEnergy;
        }

        // ============ HISTORY ============
        function renderHistory() {
            const container = document.getElementById('history-container');
            const entries = Object.entries(appData.dailyLogs)
                .sort((a, b) => parseDate(b[0]) - parseDate(a[0]))
                .slice(0, 30);

            if (entries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">No entries yet. Start tracking from the calendar!</p>';
                return;
            }

            container.innerHTML = entries.map(([dateStr, log]) => {
                const date = parseDate(dateStr);
                const meds = getMedsForDate(date);

                return `
                    <div class="entry-card">
                        <div class="entry-header">
                            <span class="entry-date">${formatDate(date)}</span>
                            <button onclick="deleteEntry('${dateStr}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">Delete</button>
                        </div>
                        <div class="entry-meds">
                            ${meds.map(med => `
                                <span class="entry-med-badge ${log.medications && log.medications[med.id] ? 'taken' : 'missed'}">
                                    ${med.emoji} ${med.name}
                                </span>
                            `).join('')}
                        </div>
                        ${log.sleep && log.sleep.hours ? `
                            <div class="entry-sleep">
                                <strong>Sleep:</strong> ${log.sleep.hours}h | Quality: ${log.sleep.quality || '-'}/10 |
                                Wake-ups: ${log.sleep.wakeups || '-'} | Morning Energy: ${log.sleep.morningEnergy || '-'}/10
                            </div>
                        ` : ''}
                        ${log.symptoms ? `
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                                <span style="background: #e9ecef; padding: 5px 10px; border-radius: 8px; font-size: 0.85em;">Energy: ${log.symptoms.energy}/10</span>
                                <span style="background: #e9ecef; padding: 5px 10px; border-radius: 8px; font-size: 0.85em;">Mood: ${log.symptoms.mood}/10</span>
                                <span style="background: #e9ecef; padding: 5px 10px; border-radius: 8px; font-size: 0.85em;">Libido: ${log.symptoms.libido}/10</span>
                                <span style="background: #e9ecef; padding: 5px 10px; border-radius: 8px; font-size: 0.85em;">Clarity: ${log.symptoms.clarity}/10</span>
                            </div>
                        ` : ''}
                        ${log.notes ? `<div class="entry-notes">${log.notes}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function deleteEntry(dateStr) {
            if (confirm('Delete this entry?')) {
                delete appData.dailyLogs[dateStr];
                saveData();
                renderHistory();
                renderCalendar();
                updateStats();
            }
        }

        // ============ SLEEP TRENDS ============
        function renderSleepChart() {
            const ctx = document.getElementById('sleepChart').getContext('2d');

            // Get last 30 days of data
            const dates = [];
            const dateKeys = [];
            const hours = [];
            const quality = [];

            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = formatDateKey(date);
                const log = appData.dailyLogs[dateStr];

                dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                dateKeys.push(dateStr);
                hours.push(log && log.sleep && log.sleep.hours ? log.sleep.hours : null);
                quality.push(log && log.sleep && log.sleep.quality ? log.sleep.quality : null);
            }

            // Find restart date index
            let restartIndex = -1;
            if (appData.wellbutrinRestartDate) {
                restartIndex = dateKeys.indexOf(appData.wellbutrinRestartDate);
            }

            if (sleepChart) {
                sleepChart.destroy();
            }

            // Custom plugin to draw vertical line for restart date
            const restartLinePlugin = {
                id: 'sleepRestartLine',
                afterDraw: (chart) => {
                    if (restartIndex === -1) return;

                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;
                    const x = xAxis.getPixelForValue(restartIndex);

                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, yAxis.top);
                    ctx.lineTo(x, yAxis.bottom);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#e67e22';
                    ctx.setLineDash([6, 4]);
                    ctx.stroke();

                    // Draw label
                    ctx.fillStyle = '#e67e22';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('WB Restart', x, yAxis.top - 8);
                    ctx.restore();
                }
            };

            sleepChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Hours Slept',
                            data: hours,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Sleep Quality',
                            data: quality,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: false,
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 30
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Hours' },
                            min: 0,
                            max: 12
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Quality (1-10)' },
                            min: 0,
                            max: 10,
                            grid: { drawOnChartArea: false }
                        }
                    }
                },
                plugins: [restartLinePlugin]
            });
        }

        function updateSleepStats() {
            const logs = Object.values(appData.dailyLogs).filter(l => l.sleep && l.sleep.hours);

            if (logs.length === 0) {
                document.getElementById('sleep-avg-hours').textContent = '-';
                document.getElementById('sleep-avg-quality').textContent = '-';
                document.getElementById('sleep-best').textContent = '-';
                document.getElementById('sleep-avg-wakeups').textContent = '-';
                return;
            }

            const hours = logs.map(l => l.sleep.hours);
            const quality = logs.filter(l => l.sleep.quality).map(l => l.sleep.quality);
            const wakeups = logs.filter(l => l.sleep.wakeups !== null).map(l => l.sleep.wakeups);

            document.getElementById('sleep-avg-hours').textContent = (hours.reduce((a, b) => a + b, 0) / hours.length).toFixed(1);
            document.getElementById('sleep-avg-quality').textContent = quality.length > 0 ? (quality.reduce((a, b) => a + b, 0) / quality.length).toFixed(1) : '-';
            document.getElementById('sleep-best').textContent = Math.max(...hours).toFixed(1) + 'h';
            document.getElementById('sleep-avg-wakeups').textContent = wakeups.length > 0 ? (wakeups.reduce((a, b) => a + b, 0) / wakeups.length).toFixed(1) : '-';
        }

        // ============ SYMPTOM CHART ============
        function renderSymptomChart() {
            const ctx = document.getElementById('symptomChart').getContext('2d');

            // Get selected metrics
            const metrics = {
                motivation: { show: document.getElementById('chart-motivation').checked, color: '#667eea', label: 'Motivation' },
                energy: { show: document.getElementById('chart-energy').checked, color: '#28a745', label: 'Energy' },
                mood: { show: document.getElementById('chart-mood').checked, color: '#ffc107', label: 'Mood' },
                libido: { show: document.getElementById('chart-libido').checked, color: '#e83e8c', label: 'Libido' },
                clarity: { show: document.getElementById('chart-clarity').checked, color: '#17a2b8', label: 'Mental Clarity' },
                anxiety: { show: document.getElementById('chart-anxiety').checked, color: '#dc3545', label: 'Anxiety' },
                wellbeing: { show: document.getElementById('chart-wellbeing').checked, color: '#6f42c1', label: 'Well-being' },
                temperature: { show: document.getElementById('chart-temperature').checked, color: '#fd7e14', label: 'Temperature' }
            };

            // Get last 30 days of data
            const dates = [];
            const dateKeys = [];
            const data = {};
            Object.keys(metrics).forEach(key => data[key] = []);

            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = formatDateKey(date);
                const log = appData.dailyLogs[dateStr];

                dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                dateKeys.push(dateStr);

                Object.keys(metrics).forEach(key => {
                    data[key].push(log && log.symptoms && log.symptoms[key] !== undefined ? log.symptoms[key] : null);
                });
            }

            // Find restart date index
            let restartIndex = -1;
            if (appData.wellbutrinRestartDate) {
                restartIndex = dateKeys.indexOf(appData.wellbutrinRestartDate);
            }

            if (symptomChart) {
                symptomChart.destroy();
            }

            // Build datasets for selected metrics
            const datasets = [];
            Object.keys(metrics).forEach(key => {
                if (metrics[key].show) {
                    datasets.push({
                        label: metrics[key].label,
                        data: data[key],
                        borderColor: metrics[key].color,
                        backgroundColor: metrics[key].color + '20',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        spanGaps: true
                    });
                }
            });

            // Custom plugin to draw vertical line for restart date
            const restartLinePlugin = {
                id: 'restartLine',
                afterDraw: (chart) => {
                    if (restartIndex === -1) return;

                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;
                    const x = xAxis.getPixelForValue(restartIndex);

                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, yAxis.top);
                    ctx.lineTo(x, yAxis.bottom);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#e67e22';
                    ctx.setLineDash([6, 4]);
                    ctx.stroke();

                    // Draw label
                    ctx.fillStyle = '#e67e22';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('WB Restart', x, yAxis.top - 8);
                    ctx.restore();
                }
            };

            symptomChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 30
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            min: 1,
                            max: 10,
                            title: {
                                display: true,
                                text: 'Rating (1-10)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                },
                plugins: [restartLinePlugin]
            });
        }

        function updateSymptomStats() {
            const logs = Object.values(appData.dailyLogs).filter(l => l.symptoms);

            if (logs.length === 0) {
                document.getElementById('symptom-avg-motivation').textContent = '-';
                document.getElementById('symptom-avg-energy').textContent = '-';
                document.getElementById('symptom-avg-mood').textContent = '-';
                document.getElementById('symptom-avg-temperature').textContent = '-';
                return;
            }

            const motivation = logs.filter(l => l.symptoms.motivation).map(l => l.symptoms.motivation);
            const energy = logs.filter(l => l.symptoms.energy).map(l => l.symptoms.energy);
            const mood = logs.filter(l => l.symptoms.mood).map(l => l.symptoms.mood);
            const temperature = logs.filter(l => l.symptoms.temperature).map(l => l.symptoms.temperature);

            document.getElementById('symptom-avg-motivation').textContent = motivation.length > 0 ? (motivation.reduce((a, b) => a + b, 0) / motivation.length).toFixed(1) : '-';
            document.getElementById('symptom-avg-energy').textContent = energy.length > 0 ? (energy.reduce((a, b) => a + b, 0) / energy.length).toFixed(1) : '-';
            document.getElementById('symptom-avg-mood').textContent = mood.length > 0 ? (mood.reduce((a, b) => a + b, 0) / mood.length).toFixed(1) : '-';
            document.getElementById('symptom-avg-temperature').textContent = temperature.length > 0 ? (temperature.reduce((a, b) => a + b, 0) / temperature.length).toFixed(1) : '-';
        }

        function saveWellbutrinRestartDate() {
            const dateInput = document.getElementById('wellbutrin-restart-date').value;
            appData.wellbutrinRestartDate = dateInput || null;
            saveData();
            renderSymptomChart();
        }

        function loadWellbutrinRestartDate() {
            // Set today as default restart date if not already set
            if (!appData.wellbutrinRestartDate) {
                const today = new Date();
                const dateStr = today.getFullYear() + '-' +
                    String(today.getMonth() + 1).padStart(2, '0') + '-' +
                    String(today.getDate()).padStart(2, '0');
                appData.wellbutrinRestartDate = dateStr;
                saveData();
            }
            const dateInput = document.getElementById('wellbutrin-restart-date');
            if (dateInput) {
                dateInput.value = appData.wellbutrinRestartDate;
            }
        }

        // ============ TRT & NAD+ TRACKING ============
        function saveTrtStartDate() {
            appData.trtStartDate = document.getElementById('trt-start-date-input').value || null;
            saveData();
            updateShotDashboard();
        }

        function saveNadStartDate() {
            appData.nadStartDate = document.getElementById('nad-start-date-input').value || null;
            saveData();
            updateShotDashboard();
        }

        function updateShotDashboard() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Load start dates into inputs
            if (appData.trtStartDate) {
                document.getElementById('trt-start-date-input').value = appData.trtStartDate;
            }
            if (appData.nadStartDate) {
                document.getElementById('nad-start-date-input').value = appData.nadStartDate;
            }

            // Calculate days on TRT
            if (appData.trtStartDate) {
                const trtStart = parseDate(appData.trtStartDate);
                const daysDiff = Math.floor((today - trtStart) / (1000 * 60 * 60 * 24));
                document.getElementById('trt-days-badge').textContent = daysDiff;
            }

            // Calculate days on NAD+
            if (appData.nadStartDate) {
                const nadStart = parseDate(appData.nadStartDate);
                const daysDiff = Math.floor((today - nadStart) / (1000 * 60 * 60 * 24));
                document.getElementById('nad-days-badge').textContent = daysDiff;
            }

            // Find last TRT shot from logs
            let lastTrtDate = null;
            let lastNadDate = null;

            const sortedDates = Object.keys(appData.dailyLogs).sort((a, b) => parseDate(b) - parseDate(a));
            for (const dateStr of sortedDates) {
                const log = appData.dailyLogs[dateStr];
                if (log && log.medications) {
                    if (!lastTrtDate && log.medications.trt) {
                        lastTrtDate = dateStr;
                    }
                    if (!lastNadDate && log.medications.nad) {
                        lastNadDate = dateStr;
                    }
                    if (lastTrtDate && lastNadDate) break;
                }
            }

            // Update TRT last shot and next due
            if (lastTrtDate) {
                const lastDate = parseDate(lastTrtDate);
                document.getElementById('trt-last-shot').textContent = formatDate(lastDate);

                // Show injection site
                const trtLog = appData.dailyLogs[lastTrtDate];
                const trtSite = trtLog && trtLog.injectionSites && trtLog.injectionSites.trt;
                document.getElementById('trt-last-site').textContent = trtSite ? formatSiteName(trtSite) : '';

                // TRT is weekly (every Friday), calculate next due
                const nextDue = new Date(lastDate);
                nextDue.setDate(nextDue.getDate() + 7);
                const daysUntil = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24));

                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = dayNames[nextDue.getDay()];

                if (daysUntil <= 0) {
                    document.getElementById('trt-next-due').innerHTML = `<span style="color: #ffeb3b; font-weight: bold;">OVERDUE!</span>`;
                } else if (daysUntil === 1) {
                    document.getElementById('trt-next-due').innerHTML = `<span style="color: #ffeb3b;">Tomorrow</span>`;
                } else if (daysUntil <= 2) {
                    document.getElementById('trt-next-due').innerHTML = `<span style="color: #ffeb3b;">${dayName} (${daysUntil} days)</span>`;
                } else {
                    document.getElementById('trt-next-due').textContent = `${dayName} (${daysUntil} days)`;
                }
            } else {
                document.getElementById('trt-last-shot').textContent = 'Not recorded';
                document.getElementById('trt-last-site').textContent = '';
                document.getElementById('trt-next-due').textContent = 'Mark your first shot!';
            }

            // Update NAD+ last shot and next due
            if (lastNadDate) {
                const lastDate = parseDate(lastNadDate);
                document.getElementById('nad-last-shot').textContent = formatDate(lastDate);

                // Show injection site
                const nadLog = appData.dailyLogs[lastNadDate];
                const nadSite = nadLog && nadLog.injectionSites && nadLog.injectionSites.nad;
                document.getElementById('nad-last-site').textContent = nadSite ? formatSiteName(nadSite) : '';

                // Update Site Rotation section
                document.getElementById('nad-last-used-date').textContent = formatDate(lastDate);
                document.getElementById('nad-last-used-site').textContent = nadSite ? formatSiteName(nadSite) : 'Not recorded';

                // Today's date and recommended site (alternate from last)
                document.getElementById('nad-use-today-date').textContent = formatDate(today);
                const recommendedSite = nadSite === 'left' ? 'Right Side' : nadSite === 'right' ? 'Left Side' : 'Left Side';
                document.getElementById('nad-use-today-site').textContent = recommendedSite;

                // NAD+ is weekly (every Monday), calculate next due
                const nextDue = new Date(lastDate);
                nextDue.setDate(nextDue.getDate() + 7);
                const daysUntil = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24));

                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const dayName = dayNames[nextDue.getDay()];

                if (daysUntil <= 0) {
                    document.getElementById('nad-next-due').innerHTML = `<span style="color: #ffeb3b; font-weight: bold;">OVERDUE!</span>`;
                } else if (daysUntil === 1) {
                    document.getElementById('nad-next-due').innerHTML = `<span style="color: #ffeb3b;">Tomorrow</span>`;
                } else if (daysUntil <= 2) {
                    document.getElementById('nad-next-due').innerHTML = `<span style="color: #ffeb3b;">${dayName} (${daysUntil} days)</span>`;
                } else {
                    document.getElementById('nad-next-due').textContent = `${dayName} (${daysUntil} days)`;
                }
            } else {
                document.getElementById('nad-last-shot').textContent = 'Not recorded';
                document.getElementById('nad-last-site').textContent = '';
                document.getElementById('nad-next-due').textContent = 'Mark your first shot!';

                // Site Rotation defaults when no history
                document.getElementById('nad-last-used-date').textContent = '-';
                document.getElementById('nad-last-used-site').textContent = 'No history';
                document.getElementById('nad-use-today-date').textContent = formatDate(today);
                document.getElementById('nad-use-today-site').textContent = 'Left Side';
            }
        }

        // Helper to format injection site names for display
        function formatSiteName(site) {
            const siteNames = {
                'left': 'Left Side',
                'right': 'Right Side',
                'left-glute': 'Left Glute',
                'right-glute': 'Right Glute',
                'left-thigh': 'Left Thigh',
                'right-thigh': 'Right Thigh',
                'left-delt': 'Left Delt',
                'right-delt': 'Right Delt',
                'abdomen': 'Abdomen'
            };
            return siteNames[site] || site;
        }

        // ============ MINI STATUS CHARTS ============
        function renderTrtMiniChart() {
            const canvas = document.getElementById('trt-mini-chart');
            const emptyMsg = document.getElementById('trt-chart-empty');

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Use the stored TRT start date
            if (!appData.trtStartDate) {
                canvas.style.display = 'none';
                emptyMsg.style.display = 'block';
                emptyMsg.textContent = 'Set your TRT start date to see libido trends';
                return;
            }

            const firstTrtDate = parseDate(appData.trtStartDate);

            const labels = [];
            const libidoData = [];
            const pointColors = [];
            const shotDayIndices = [];
            let index = 0;

            // Loop from first TRT shot date to today
            const currentDate = new Date(firstTrtDate);
            while (currentDate <= today) {
                const dateKey = formatDateKey(currentDate);
                const log = appData.dailyLogs[dateKey];

                labels.push(`${currentDate.getMonth()+1}/${currentDate.getDate()}`);

                // Check if TRT was taken this day
                if (log && log.medications && log.medications.trt) {
                    pointColors.push('#8b5a83'); // Muted mauve for shot days
                    shotDayIndices.push(index);
                } else {
                    pointColors.push('rgba(255,255,255,0.6)'); // Subtle white for non-shot days
                }

                if (log && log.symptoms && log.symptoms.libido !== undefined) {
                    libidoData.push(log.symptoms.libido);
                } else {
                    libidoData.push(null);
                }

                index++;
                // Move to next day
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Show chart even without libido data (to display start date)
            const hasData = libidoData.some(l => l !== null);

            if (!hasData && labels.length < 2) {
                canvas.style.display = 'none';
                emptyMsg.style.display = 'block';
                emptyMsg.textContent = 'Log libido levels to see trends from your TRT start date';
                return;
            }

            canvas.style.display = 'block';
            emptyMsg.style.display = 'none';

            // Find Wellbutrin restart date index
            let wbRestartIndex = -1;
            if (appData.wellbutrinRestartDate) {
                const wbDate = parseDate(appData.wellbutrinRestartDate);
                const wbDateStr = `${wbDate.getMonth()+1}/${wbDate.getDate()}`;
                wbRestartIndex = labels.indexOf(wbDateStr);
            }

            // Plugin to draw Wellbutrin restart line
            const wbRestartPlugin = {
                id: 'trtWbRestart',
                afterDraw: (chart) => {
                    if (wbRestartIndex === -1) return;
                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;
                    const x = xAxis.getPixelForValue(wbRestartIndex);
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, yAxis.top);
                    ctx.lineTo(x, yAxis.bottom);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#e67e22';
                    ctx.setLineDash([4, 3]);
                    ctx.stroke();
                    ctx.fillStyle = '#e67e22';
                    ctx.font = '8px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('WB', x, yAxis.top - 3);
                    ctx.restore();
                }
            };

            if (trtMiniChart) trtMiniChart.destroy();

            trtMiniChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Libido',
                        data: libidoData,
                        borderColor: 'rgba(255, 255, 255, 0.9)',
                        backgroundColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointColors,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 10 } },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            callbacks: {
                                label: (ctx) => {
                                    if (ctx.parsed.y === null) return 'No data';
                                    return `Libido: ${ctx.parsed.y}/10`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'rgba(255,255,255,0.7)',
                                font: { size: 9 },
                                maxRotation: 45,
                                maxTicksLimit: 8,
                                callback: function(value, idx) {
                                    // Show first, last, and evenly spaced dates
                                    const total = labels.length;
                                    if (total <= 8) return labels[idx];
                                    const step = Math.floor(total / 6);
                                    if (idx === 0 || idx === total - 1 || idx % step === 0) {
                                        return labels[idx];
                                    }
                                    return '';
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            min: 1,
                            max: 10,
                            ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 10 } },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                },
                plugins: [wbRestartPlugin]
            });
        }

        function renderNadMiniChart() {
            const canvas = document.getElementById('nad-mini-chart');
            const emptyMsg = document.getElementById('nad-chart-empty');

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Use the stored NAD+ start date
            if (!appData.nadStartDate) {
                canvas.style.display = 'none';
                emptyMsg.style.display = 'block';
                emptyMsg.textContent = 'Set your NAD+ start date to see energy trends';
                return;
            }

            const firstNadDate = parseDate(appData.nadStartDate);

            const labels = [];
            const energyData = [];
            const pointColors = [];
            const shotDayIndices = [];
            let index = 0;

            // Loop from first NAD+ shot date to today
            const currentDate = new Date(firstNadDate);
            while (currentDate <= today) {
                const dateKey = formatDateKey(currentDate);
                const log = appData.dailyLogs[dateKey];

                labels.push(`${currentDate.getMonth()+1}/${currentDate.getDate()}`);

                // Check if NAD+ was taken this day
                if (log && log.medications && log.medications.nad) {
                    pointColors.push('#5a7b8b'); // Muted teal for shot days
                    shotDayIndices.push(index);
                } else {
                    pointColors.push('rgba(255,255,255,0.6)'); // Subtle white for non-shot days
                }

                if (log && log.symptoms && log.symptoms.energy !== undefined) {
                    energyData.push(log.symptoms.energy);
                } else {
                    energyData.push(null);
                }

                index++;
                // Move to next day
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Show chart even without energy data (to display start date)
            const hasData = energyData.some(e => e !== null);

            if (!hasData && labels.length < 2) {
                canvas.style.display = 'none';
                emptyMsg.style.display = 'block';
                emptyMsg.textContent = 'Log energy levels to see trends from your NAD+ start date';
                return;
            }

            canvas.style.display = 'block';
            emptyMsg.style.display = 'none';

            // Find Wellbutrin restart date index
            let wbRestartIndex = -1;
            if (appData.wellbutrinRestartDate) {
                const wbDate = parseDate(appData.wellbutrinRestartDate);
                const wbDateStr = `${wbDate.getMonth()+1}/${wbDate.getDate()}`;
                wbRestartIndex = labels.indexOf(wbDateStr);
            }

            // Plugin to draw Wellbutrin restart line
            const wbRestartPlugin = {
                id: 'nadWbRestart',
                afterDraw: (chart) => {
                    if (wbRestartIndex === -1) return;
                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;
                    const x = xAxis.getPixelForValue(wbRestartIndex);

                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, yAxis.top);
                    ctx.lineTo(x, yAxis.bottom);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#e67e22';
                    ctx.setLineDash([4, 3]);
                    ctx.stroke();

                    // Label
                    ctx.fillStyle = '#e67e22';
                    ctx.font = '8px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('WB', x, yAxis.top - 3);
                    ctx.restore();
                }
            };

            if (nadMiniChart) nadMiniChart.destroy();

            nadMiniChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Energy',
                        data: energyData,
                        borderColor: 'rgba(255, 255, 255, 0.9)',
                        backgroundColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointColors,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            callbacks: {
                                label: (ctx) => {
                                    if (ctx.parsed.y === null) return 'No data';
                                    return `Energy: ${ctx.parsed.y}/10`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'rgba(255,255,255,0.7)',
                                font: { size: 9 },
                                maxRotation: 45,
                                maxTicksLimit: 8,
                                callback: function(value, idx) {
                                    // Show first, last, and evenly spaced dates
                                    const total = labels.length;
                                    if (total <= 8) return labels[idx];
                                    const step = Math.floor(total / 6);
                                    if (idx === 0 || idx === total - 1 || idx % step === 0) {
                                        return labels[idx];
                                    }
                                    return '';
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            min: 1,
                            max: 10,
                            ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 10 } },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                },
                plugins: [wbRestartPlugin]
            });
        }

        // ============ TAPERING ============
        function renderTaperingTab() {
            if (appData.tapering.started) {
                document.getElementById('taper-not-started').style.display = 'none';
                document.getElementById('taper-active').style.display = 'block';
                renderTaperTimeline();
                renderWithdrawalLog();
            } else {
                document.getElementById('taper-not-started').style.display = 'block';
                document.getElementById('taper-active').style.display = 'none';
            }
        }

        function startTaper() {
            const startDate = document.getElementById('taper-start-date').value;
            if (!startDate) {
                alert('Please select a start date');
                return;
            }

            appData.tapering.started = true;
            appData.tapering.startDate = startDate;

            // Calculate phase start dates
            let currentStart = parseDate(startDate);
            appData.tapering.schedule.forEach((phase, index) => {
                phase.startDate = formatDateKey(currentStart);
                currentStart.setDate(currentStart.getDate() + (phase.weeks * 7));
            });

            saveData();
            renderTaperingTab();
        }

        function renderTaperTimeline() {
            const timeline = document.getElementById('taper-timeline');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let currentPhase = null;

            timeline.innerHTML = appData.tapering.schedule.map((phase, index) => {
                const startDate = phase.startDate ? parseDate(phase.startDate) : null;
                let endDate = null;
                if (startDate && phase.weeks > 0) {
                    endDate = new Date(startDate.getTime());
                    endDate.setDate(endDate.getDate() + (phase.weeks * 7));
                }

                let status = 'future';
                if (startDate && today >= startDate && (!endDate || today < endDate)) {
                    status = 'active';
                    currentPhase = phase;
                } else if (endDate && today >= endDate) {
                    status = 'completed';
                }

                return `
                    <div class="taper-phase ${status}">
                        <h4>${phase.dose === 0 ? 'Complete!' : phase.dose + 'mg XL'}</h4>
                        <p>${phase.weeks > 0 ? phase.weeks + ' weeks' : 'Finished tapering'}</p>
                        ${startDate ? `<p style="font-size: 0.85em; color: #6c757d;">Starts: ${formatDate(startDate)}</p>` : ''}
                    </div>
                `;
            }).join('');

            // Update stats
            if (currentPhase) {
                document.getElementById('taper-current-dose').textContent = currentPhase.dose + 'mg';

                const phaseStart = parseDate(currentPhase.startDate);
                const daysAtDose = Math.floor((today - phaseStart) / (1000 * 60 * 60 * 24));
                document.getElementById('taper-days-at-dose').textContent = daysAtDose;

                const nextPhaseIndex = appData.tapering.schedule.indexOf(currentPhase) + 1;
                if (nextPhaseIndex < appData.tapering.schedule.length) {
                    const nextPhase = appData.tapering.schedule[nextPhaseIndex];
                    document.getElementById('taper-next-date').textContent = nextPhase.startDate ? formatDate(parseDate(nextPhase.startDate)) : '-';
                } else {
                    document.getElementById('taper-next-date').textContent = 'Done!';
                }

                // Calculate progress
                const completedPhases = appData.tapering.schedule.filter((p, i) => {
                    if (!p.startDate) return false;
                    const endDate = parseDate(p.startDate);
                    endDate.setDate(endDate.getDate() + (p.weeks * 7));
                    return today >= endDate;
                }).length;
                const progress = Math.round((completedPhases / appData.tapering.schedule.length) * 100);
                document.getElementById('taper-progress').textContent = progress + '%';
            }
        }

        function logWithdrawalSymptom() {
            const date = document.getElementById('withdrawal-date').value;
            const severity = document.getElementById('withdrawal-severity').value;
            const notes = document.getElementById('withdrawal-notes').value;

            if (!date || !severity) {
                alert('Please fill in date and severity');
                return;
            }

            appData.tapering.symptoms.push({
                date,
                severity: parseInt(severity),
                notes
            });

            appData.tapering.symptoms.sort((a, b) => parseDate(b.date) - parseDate(a.date));
            saveData();

            document.getElementById('withdrawal-severity').value = '';
            document.getElementById('withdrawal-notes').value = '';

            renderWithdrawalLog();
        }

        function renderWithdrawalLog() {
            const container = document.getElementById('withdrawal-log');

            if (appData.tapering.symptoms.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">No symptoms logged yet.</p>';
                return;
            }

            container.innerHTML = appData.tapering.symptoms.map((symptom, index) => `
                <div class="entry-card" style="border-left-color: ${symptom.severity >= 7 ? '#dc3545' : symptom.severity >= 4 ? '#ffc107' : '#28a745'};">
                    <div class="entry-header">
                        <span class="entry-date">${formatDate(parseDate(symptom.date))}</span>
                        <span style="font-weight: bold; color: ${symptom.severity >= 7 ? '#dc3545' : symptom.severity >= 4 ? '#ffc107' : '#28a745'};">
                            Severity: ${symptom.severity}/10
                        </span>
                    </div>
                    <p>${symptom.notes || 'No notes'}</p>
                </div>
            `).join('');
        }

        function resetTaper() {
            if (confirm('Are you sure you want to reset your tapering plan? This will clear all progress and symptom logs.')) {
                appData.tapering = {
                    medication: 'Wellbutrin',
                    currentDose: 300,
                    schedule: [
                        { dose: 300, weeks: 4, startDate: null },
                        { dose: 150, weeks: 4, startDate: null },
                        { dose: 75, weeks: 2, startDate: null },
                        { dose: 0, weeks: 0, startDate: null }
                    ],
                    started: false,
                    startDate: null,
                    symptoms: []
                };
                saveData();
                renderTaperingTab();
            }
        }

        // ============ LABS ============
        function renderLabsTab() {
            renderLabsHistory();
            updateLabChart();
        }

        function renderLabsHistory() {
            const container = document.getElementById('labs-container');

            if (appData.labResults.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">No lab results yet.</p>';
                return;
            }

            const sorted = appData.labResults
                .map((lab, originalIndex) => ({ ...lab, originalIndex }))
                .sort((a, b) => parseDate(b.date) - parseDate(a.date));

            container.innerHTML = sorted.map((lab) => {
                // Build lab values dynamically
                const labFields = [
                    { key: 'testosterone', label: 'Testosterone', unit: 'ng/dL' },
                    { key: 'testosteroneFree', label: 'Free T', unit: 'pg/mL' },
                    { key: 'estradiol', label: 'Estradiol', unit: 'pg/mL' },
                    { key: 'progesterone', label: 'Progesterone', unit: 'ng/mL' },
                    { key: 'shbg', label: 'SHBG', unit: 'nmol/L' },
                    { key: 'prolactin', label: 'Prolactin', unit: 'ng/mL' },
                    { key: 'dhea', label: 'DHEA-S', unit: 'ug/dL' },
                    { key: 'tsh', label: 'TSH', unit: 'uIU/mL' },
                    { key: 't4', label: 'Free T4', unit: 'ng/dL' },
                    { key: 't3', label: 'Free T3', unit: 'pg/mL' },
                    { key: 'vitd', label: 'Vitamin D', unit: 'ng/mL' },
                    { key: 'b12', label: 'B12', unit: 'pg/mL' },
                    { key: 'ferritin', label: 'Ferritin', unit: 'ng/mL' },
                    { key: 'glucose', label: 'Glucose', unit: 'mg/dL' },
                    { key: 'hba1c', label: 'HbA1c', unit: '%' },
                    { key: 'cholesterol', label: 'Cholesterol', unit: 'mg/dL' },
                    { key: 'ldl', label: 'LDL', unit: 'mg/dL' },
                    { key: 'hdl', label: 'HDL', unit: 'mg/dL' },
                    { key: 'triglycerides', label: 'Triglycerides', unit: 'mg/dL' }
                ];

                const valuesHtml = labFields
                    .filter(f => lab[f.key] != null)
                    .map(f => `<div class="lab-value-item"><div class="name">${f.label}</div><div class="value">${lab[f.key]} ${f.unit}</div></div>`)
                    .join('');

                return `
                    <div class="lab-card">
                        <div class="lab-header">
                            <span class="lab-date">${formatDate(parseDate(lab.date))}</span>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="editLabEntry(${lab.originalIndex})" style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">Edit</button>
                                <button onclick="deleteLabEntry(${lab.originalIndex})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">Delete</button>
                            </div>
                        </div>
                        <div class="lab-values">
                            ${valuesHtml}
                        </div>
                        ${lab.notes ? `<p style="margin-top: 10px; color: #6c757d; font-style: italic;">${lab.notes}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        function saveLabEntry() {
            const entry = {
                date: document.getElementById('lab-date').value,
                // Hormones
                testosterone: parseFloat(document.getElementById('lab-testosterone').value) || null,
                testosteroneFree: parseFloat(document.getElementById('lab-testosterone-free').value) || null,
                estradiol: parseFloat(document.getElementById('lab-estradiol').value) || null,
                progesterone: parseFloat(document.getElementById('lab-progesterone').value) || null,
                shbg: parseFloat(document.getElementById('lab-shbg').value) || null,
                prolactin: parseFloat(document.getElementById('lab-prolactin').value) || null,
                dhea: parseFloat(document.getElementById('lab-dhea').value) || null,
                // Thyroid
                tsh: parseFloat(document.getElementById('lab-tsh').value) || null,
                t4: parseFloat(document.getElementById('lab-t4').value) || null,
                t3: parseFloat(document.getElementById('lab-t3').value) || null,
                // Vitamins
                vitd: parseFloat(document.getElementById('lab-vitd').value) || null,
                b12: parseFloat(document.getElementById('lab-b12').value) || null,
                ferritin: parseFloat(document.getElementById('lab-ferritin').value) || null,
                // Metabolic
                glucose: parseFloat(document.getElementById('lab-glucose').value) || null,
                hba1c: parseFloat(document.getElementById('lab-hba1c').value) || null,
                cholesterol: parseFloat(document.getElementById('lab-cholesterol').value) || null,
                ldl: parseFloat(document.getElementById('lab-ldl').value) || null,
                hdl: parseFloat(document.getElementById('lab-hdl').value) || null,
                triglycerides: parseFloat(document.getElementById('lab-triglycerides').value) || null,
                notes: document.getElementById('lab-notes').value
            };

            if (!entry.date) {
                alert('Please select a date');
                return;
            }

            console.log('editingLabIndex:', editingLabIndex);

            if (editingLabIndex !== null && editingLabIndex >= 0) {
                // Update existing entry
                appData.labResults[editingLabIndex] = entry;
                editingLabIndex = null;
                document.getElementById('lab-save-btn').textContent = 'Save Lab Results';
                document.getElementById('lab-cancel-btn').style.display = 'none';
                alert('Lab results updated!');
            } else {
                // Add new entry
                appData.labResults.push(entry);
                alert('Lab results saved!');
            }

            saveData();

            // Clear form - all fields
            const labFields = ['lab-date', 'lab-testosterone', 'lab-testosterone-free', 'lab-estradiol', 'lab-progesterone',
                'lab-shbg', 'lab-prolactin', 'lab-dhea', 'lab-tsh', 'lab-t4', 'lab-t3', 'lab-vitd', 'lab-b12',
                'lab-ferritin', 'lab-glucose', 'lab-hba1c', 'lab-cholesterol', 'lab-ldl', 'lab-hdl',
                'lab-triglycerides', 'lab-notes'];
            labFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });

            renderLabsTab();
        }

        function deleteLabEntry(index) {
            if (confirm('Delete this lab entry?')) {
                appData.labResults.splice(index, 1);
                saveData();
                renderLabsTab();
            }
        }

        function editLabEntry(index) {
            console.log('Editing lab at index:', index);
            const lab = appData.labResults[index];
            if (!lab) {
                alert('Lab entry not found at index ' + index);
                return;
            }

            editingLabIndex = index;
            console.log('editingLabIndex set to:', editingLabIndex);

            // Populate form with existing values
            // Convert date to YYYY-MM-DD format for the date input
            let dateValue = lab.date || '';
            if (dateValue && !dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                // Try to parse and reformat the date
                const parsed = parseDate(dateValue);
                if (!isNaN(parsed)) {
                    dateValue = parsed.toISOString().split('T')[0];
                }
            }
            document.getElementById('lab-date').value = dateValue;
            document.getElementById('lab-testosterone').value = lab.testosterone || '';
            document.getElementById('lab-testosterone-free').value = lab.testosteroneFree || '';
            document.getElementById('lab-estradiol').value = lab.estradiol || '';
            document.getElementById('lab-progesterone').value = lab.progesterone || '';
            document.getElementById('lab-shbg').value = lab.shbg || '';
            document.getElementById('lab-prolactin').value = lab.prolactin || '';
            document.getElementById('lab-dhea').value = lab.dhea || '';
            document.getElementById('lab-tsh').value = lab.tsh || '';
            document.getElementById('lab-t4').value = lab.t4 || '';
            document.getElementById('lab-t3').value = lab.t3 || '';
            document.getElementById('lab-vitd').value = lab.vitd || '';
            document.getElementById('lab-b12').value = lab.b12 || '';
            document.getElementById('lab-ferritin').value = lab.ferritin || '';
            document.getElementById('lab-glucose').value = lab.glucose || '';
            document.getElementById('lab-hba1c').value = lab.hba1c || '';
            document.getElementById('lab-cholesterol').value = lab.cholesterol || '';
            document.getElementById('lab-ldl').value = lab.ldl || '';
            document.getElementById('lab-hdl').value = lab.hdl || '';
            document.getElementById('lab-triglycerides').value = lab.triglycerides || '';
            document.getElementById('lab-notes').value = lab.notes || '';

            // Update button text
            document.getElementById('lab-save-btn').textContent = 'Update Lab Results';
            document.getElementById('lab-cancel-btn').style.display = 'inline-block';

            // Scroll to form
            document.getElementById('lab-date').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function cancelLabEdit() {
            editingLabIndex = null;
            document.getElementById('lab-save-btn').textContent = 'Save Lab Results';
            document.getElementById('lab-cancel-btn').style.display = 'none';

            // Clear form
            const labFields = ['lab-date', 'lab-testosterone', 'lab-testosterone-free', 'lab-estradiol', 'lab-progesterone',
                'lab-shbg', 'lab-prolactin', 'lab-dhea', 'lab-tsh', 'lab-t4', 'lab-t3', 'lab-vitd', 'lab-b12',
                'lab-ferritin', 'lab-glucose', 'lab-hba1c', 'lab-cholesterol', 'lab-ldl', 'lab-hdl',
                'lab-triglycerides', 'lab-notes'];
            labFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
        }

        function updateLabChart() {
            const ctx = document.getElementById('labChart').getContext('2d');
            const selected = document.getElementById('lab-chart-select').value;

            // Only include entries that have data for the selected lab type
            const filtered = appData.labResults
                .filter(l => l[selected] != null && l[selected] !== '')
                .sort((a, b) => parseDate(a.date) - parseDate(b.date));

            const labels = filtered.map(l => formatDate(parseDate(l.date)));
            const dateKeys = filtered.map(l => l.date);
            const data = filtered.map(l => parseFloat(l[selected]));

            const labelMap = {
                testosterone: 'Testosterone Total (ng/dL)',
                testosteroneFree: 'Free Testosterone (pg/mL)',
                estradiol: 'Estradiol (pg/mL)',
                progesterone: 'Progesterone (ng/mL)',
                shbg: 'SHBG (nmol/L)',
                prolactin: 'Prolactin (ng/mL)',
                dhea: 'DHEA-S (ug/dL)',
                tsh: 'TSH (uIU/mL)',
                t4: 'Free T4 (ng/dL)',
                t3: 'Free T3 (pg/mL)',
                vitd: 'Vitamin D (ng/mL)',
                b12: 'Vitamin B12 (pg/mL)',
                ferritin: 'Ferritin (ng/mL)',
                glucose: 'Glucose (mg/dL)',
                hba1c: 'HbA1c (%)',
                cholesterol: 'Total Cholesterol (mg/dL)',
                ldl: 'LDL (mg/dL)',
                hdl: 'HDL (mg/dL)',
                triglycerides: 'Triglycerides (mg/dL)'
            };

            // Find restart date position (interpolated between lab dates)
            let restartPosition = -1;
            if (appData.wellbutrinRestartDate && filtered.length > 0) {
                const restartTime = parseDate(appData.wellbutrinRestartDate).getTime();
                const labDates = filtered.map(l => parseDate(l.date).getTime());

                // Find where restart falls in the sequence
                for (let i = 0; i < labDates.length; i++) {
                    if (restartTime <= labDates[i]) {
                        if (i === 0) {
                            restartPosition = 0;
                        } else {
                            // Interpolate between i-1 and i
                            const ratio = (restartTime - labDates[i-1]) / (labDates[i] - labDates[i-1]);
                            restartPosition = i - 1 + ratio;
                        }
                        break;
                    }
                }
                // If restart is after all labs, place it at the end
                if (restartPosition === -1 && restartTime > labDates[labDates.length - 1]) {
                    restartPosition = labDates.length - 0.5;
                }
            }

            if (labChart) {
                labChart.destroy();
            }

            // Custom plugin to draw vertical line for restart date
            const restartLinePlugin = {
                id: 'labRestartLine',
                afterDraw: (chart) => {
                    if (restartPosition === -1) return;

                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;
                    const x = xAxis.getPixelForValue(restartPosition);

                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, yAxis.top);
                    ctx.lineTo(x, yAxis.bottom);
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = '#ff6b6b';
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();

                    // Draw label
                    ctx.fillStyle = '#ff6b6b';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Wellbutrin', x, yAxis.top - 20);
                    ctx.fillText('Restart', x, yAxis.top - 8);
                    ctx.restore();
                }
            };

            // Show message if no data for selected type
            if (filtered.length === 0) {
                labChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `No ${labelMap[selected] || selected} data recorded yet`,
                                font: { size: 16 },
                                color: '#6c757d'
                            }
                        }
                    }
                });
                return;
            }

            labChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: labelMap[selected] || selected,
                        data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.3,
                        spanGaps: true,
                        pointRadius: 6,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 8,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 30
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                },
                plugins: selected === 'ferritin' ? [] : [restartLinePlugin]
            });
        }

        // ============ REMINDERS ============
        function renderRemindersTab() {
            const scheduleContainer = document.getElementById('medication-schedule');
            const editorContainer = document.getElementById('reminder-editor');

            // Show current schedule
            scheduleContainer.innerHTML = appData.medications.map(med => `
                <div class="reminder-card">
                    <div class="reminder-info">
                        <h4>${med.emoji} ${med.name}</h4>
                        <p>${med.schedule === 'daily' ? 'Daily' : getDayName(med.days[0]) + 's'}</p>
                    </div>
                    <div class="reminder-time">${med.time || 'No time set'}</div>
                </div>
            `).join('');

            // Show editor
            editorContainer.innerHTML = appData.medications.map(med => `
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <strong>${med.emoji} ${med.name}</strong>
                        <span style="color: #6c757d; margin-left: 10px;">(${med.schedule === 'daily' ? 'Daily' : getDayName(med.days[0]) + 's'})</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="time" id="reminder-time-${med.id}" value="${med.time || ''}" style="padding: 8px; border: 2px solid #e9ecef; border-radius: 8px;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" id="reminder-enabled-${med.id}" ${med.reminderEnabled ? 'checked' : ''} style="width: 18px; height: 18px;">
                            <span style="font-size: 0.9em;">Enabled</span>
                        </label>
                    </div>
                </div>
            `).join('');

            // Update notification status banner
            updateNotificationBanner();
        }

        function saveReminderTimes() {
            appData.medications.forEach(med => {
                const timeInput = document.getElementById(`reminder-time-${med.id}`);
                const enabledInput = document.getElementById(`reminder-enabled-${med.id}`);

                if (timeInput) {
                    med.time = timeInput.value || null;
                }
                if (enabledInput) {
                    med.reminderEnabled = enabledInput.checked;
                }
            });

            saveData();
            setupReminders();
            alert('Reminder times saved!');
        }

        function saveCheckinReminder() {
            const time = document.getElementById('checkin-reminder-time').value;
            const enabled = document.getElementById('checkin-reminder-enabled').checked;

            appData.checkinReminder = {
                enabled: enabled,
                time: time || '08:00'
            };

            saveData();
            setupReminders();
            alert('Morning check-in reminder saved! You\'ll get a notification at ' + (time || '08:00') + ' daily.');
        }

        function loadCheckinReminderSettings() {
            if (appData.checkinReminder) {
                document.getElementById('checkin-reminder-time').value = appData.checkinReminder.time || '08:00';
                document.getElementById('checkin-reminder-enabled').checked = appData.checkinReminder.enabled !== false;
            }
        }

        // ============ NOTIFICATIONS ============
        function checkNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Notifications not supported');
                return;
            }

            updateNotificationBanner();
        }

        function updateNotificationBanner() {
            const banner = document.getElementById('notification-banner');
            const remindersBanner = document.getElementById('reminders-notification-status');

            if (!('Notification' in window)) {
                if (banner) banner.style.display = 'none';
                if (remindersBanner) remindersBanner.style.display = 'none';
                return;
            }

            if (Notification.permission === 'granted') {
                if (banner) banner.style.display = 'none';
                if (remindersBanner) {
                    remindersBanner.style.display = 'flex';
                    remindersBanner.classList.add('granted');
                    document.getElementById('notification-status-text').innerHTML = '<strong>Notifications enabled!</strong> You\'ll receive reminders for your medications.';
                    document.getElementById('enable-notifications-btn').style.display = 'none';
                }
            } else if (Notification.permission === 'denied') {
                if (banner) {
                    banner.style.display = 'flex';
                    banner.innerHTML = '<p><strong>Notifications blocked.</strong> Enable them in your browser settings to receive reminders.</p>';
                }
                if (remindersBanner) {
                    remindersBanner.style.display = 'flex';
                    document.getElementById('notification-status-text').innerHTML = '<strong>Notifications blocked.</strong> Enable them in your browser settings.';
                    document.getElementById('enable-notifications-btn').style.display = 'none';
                }
            } else {
                if (banner) banner.style.display = 'flex';
                if (remindersBanner) {
                    remindersBanner.style.display = 'flex';
                    document.getElementById('notification-status-text').innerHTML = '<strong>Enable notifications</strong> to get reminders for your medications.';
                    document.getElementById('enable-notifications-btn').style.display = 'block';
                }
            }
        }

        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('Your browser doesn\'t support notifications');
                return;
            }

            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    appData.settings.notificationsEnabled = true;
                    saveData();

                    // Test notification
                    new Notification('Wellness Tracker', {
                        body: 'Notifications enabled! You\'ll now receive medication reminders.',
                        icon: 'üíä'
                    });

                    setupReminders();
                }
                updateNotificationBanner();
            });
        }

        function setupReminders() {
            // Clear existing intervals
            reminderIntervals.forEach(interval => clearInterval(interval));
            reminderIntervals = [];

            if (Notification.permission !== 'granted') return;

            // Check every minute for reminders
            const checkReminders = () => {
                const now = new Date();
                const currentTime = now.toTimeString().slice(0, 5);
                const currentDay = now.getDay();

                appData.medications.forEach(med => {
                    if (!med.reminderEnabled || !med.time) return;

                    // Check if this med should be taken today
                    const shouldTakeToday = med.schedule === 'daily' || med.days.includes(currentDay);
                    if (!shouldTakeToday) return;

                    // Check if it's time
                    if (med.time === currentTime) {
                        // Check if already taken today
                        const todayStr = formatDateKey(now);
                        const log = appData.dailyLogs[todayStr];
                        const alreadyTaken = log && log.medications && log.medications[med.id];

                        if (!alreadyTaken) {
                            new Notification('Time for ' + med.name + '!', {
                                body: 'Don\'t forget to take your ' + med.name,
                                icon: med.emoji,
                                requireInteraction: true
                            });
                        }
                    }
                });

                // Check for morning check-in reminder
                if (appData.checkinReminder && appData.checkinReminder.enabled && appData.checkinReminder.time === currentTime) {
                    // Check if already logged today
                    const todayStr = formatDateKey(now);
                    const log = appData.dailyLogs[todayStr];
                    const alreadyLogged = log && log.symptoms;

                    if (!alreadyLogged) {
                        new Notification('‚òÄÔ∏è Morning Check-In Time!', {
                            body: 'How are you feeling today? Log your motivation, energy, sleep, and track your recovery progress.',
                            requireInteraction: true
                        });
                    }
                }
            };

            // Check immediately and then every minute
            checkReminders();
            const interval = setInterval(checkReminders, 60000);
            reminderIntervals.push(interval);
        }

        // ============ UTILITY FUNCTIONS ============
        // Format date as MM-DD-YYYY (Central Time)
        function formatDate(date) {
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            return `${month}-${day}-${year}`;
        }

        // Parse date string safely to avoid timezone issues
        function parseDate(dateStr) {
            // Add noon time to avoid timezone shifting to previous day
            if (dateStr.includes('T')) {
                return new Date(dateStr);
            }
            return new Date(dateStr + 'T12:00:00');
        }

        function formatDateKey(date) {
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const year = date.getFullYear();
            return `${year}-${month}-${day}`;
        }

        function getDayName(dayNum) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[dayNum];
        }

        // ============ INITIALIZE ============
        document.addEventListener('DOMContentLoaded', init);

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Close modal on overlay click
        document.getElementById('day-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) closeModal();
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
